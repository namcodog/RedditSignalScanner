# 2025-10-09 敏捷开发避坑与高效交付指南

> 目标：在真实后端（非 Mock）环境下，从 0-1 重建 Reddit Signal Scanner，最小化踩坑时间，确保 PRD 全量功能按期交付。



## 项目初始化的时候使用serena mcp工具来核查代码库，深度了解代码实现

# 必须按照下面的形式，使用简单通俗的中文语言进行回答：
  1，通过深度分析发现了什么问题？根因是什么？
  2，是否已经精确的定位到问题？
  3，精确修复问题的方法是什么？
  4，下一步的事项要完成什么？

# 每次执行任务的时候都需要列出plan，按照plan依次逐步完成。 

# 解决问题的方式，应该先使用serena工具了解代码库，定位到问题的位置，使用sequential-thinking来进行系统化的思考，使用exa-code mcp来找到最佳的实践方法，最后精确的修复问题，并且调用Chrome DevTools MCP工具验证修复结果

# 若在验证的过成超时等待超过12s，立刻停止，寻找根因。

# 每次配置或者安装好mcp工具都必须自动验证是否配置安装成功


## 0. 重写蓝图索引（快速导航）

| 作用 | 推荐文档/章节 | 要点 |
|------|----------------|------|
| 环境搭建与依赖策略 | 本指南 §7、`2025-10-09-全仓库复原与治理方案.md`（Phase0/1） | 覆盖 `make env-check`、`make dev-up`、临时变量、Docker 配置与依赖锁定；治理方案的 Phase 表可作为环境/流程的参考清单。 |
| 功能阶段拆解 | 本指南 §3“阶段执行工作表”、`docs/PRD/PRD-INDEX.md` | Phase0~Phase5 的输入/命令/输出及 PRD 映射；PRD-INDEX 已脚注说明 `make sse-test` / `make openapi-check-stream` 的现状。 |
| 技术债与待办 | `docs/archive/tech_debt_backlog_2025-10-09.md` | backlog-02/03/04 等条目对应 Phase2~3 的具体任务；完成后需同步勾选并更新此文件。 |
| 风险与质量指标 | `docs/strategy/2025-10-08-项目全面深度核查报告.md` | 提供数据管道字段错位、质量评分、Scope creep 等问题，重写阶段需对比改善。 |
| 运行日志与结果 | `reports/`（或新建 `reports/phase-log/`） | 每次执行 `make sanity-bootstrap`、`make quick-gate-local` 等命令时存档，作为阶段验收依据。 |

> 开发顺序建议：先参考本指南 §7 和治理方案 Phase0 准备干净环境 → 按 §3/PRD-INDEX 的 Phase 表逐步实现 → 使用 backlog/深核报告核对功能与质量 → 将成果记录在 `reports/` 并回写指南。

---

## 1. 项目哲学与质量底线

- **零冗余结构**：严格遵循 `docs/PRD/ARCHITECTURE.md` 的目录职责与依赖边界。禁止在 `core` 之外直接访问数据库 / 脚本目录，禁止前端绕过 `services` 直接操作 HTTP 客户端。
- **质量门禁不可绕过**：后端、前端必须 0 个 `Any`、函数/变量补齐类型。提交前跑 `make quick-gate-local` 与 `pre-commit run --all-files`，发现错误立即修复，禁止“先合再改”。
- **契约优先于代码**：任何接口/数据结构调整，须同步更新 PRD 文档与本指南引用的规范，避免“文档失真 → 开发返工”。
- **真实联调优先**：开发默认连真实 API，`VITE_USE_MOCK_API=false`。Mock 仅用于隔离式实验，结果不得直接上主干。

---

## 2. 环境准备与启动闭环（无 Mock 全链路）

### 2.1 一次性配置
- 复制根目录 `.env.example` → `.env`，统一使用 **IPv4** 与容器端口映射：
  - `VITE_API_URL=http://127.0.0.1:8008`
  - `DATABASE_URL=postgresql+asyncpg://postgres:postgres@127.0.0.1:55432/reddit_signal_scanner`
  - Redis / Celery 全部指向 `127.0.0.1`
- 若缺失，创建 `docker/postgres/postgresql.conf` 与 `pg_hba.conf`（参照 `docs/handbook/本地运行验收执行方案-2025-10-07.md`），避免宿主机配置污染。

### 2.2 标准启动顺序

> ⚠️ 当前 Makefile 尚未实现 `env-check` / `backend-hard-restart` / `dev-up` / `sse-test` / `openapi-check-stream` 目标，如直接执行会报 “No rule to make target”。在补齐前请使用下列手动流程或 `./start-dev.sh`，并将完善 Make 目标列入近期任务。

```bash
make install            # 安装后端 venv / 前端依赖
# 手动环境检查（暂时代替 make env-check）
python3 --version       # 期望 3.11.x
node --version          # 期望 18.x
pnpm --version || npm --version

# 强制重启后端（无 make 目标时）
pkill -f "uvicorn.*app.main" || true
cd backend && ./venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8008 --reload &

# 启动 Celery & 前端（若使用 start-dev.sh 会自动处理）
cd backend && celery -A app.core.celery_app worker --loglevel=info &
cd frontend && npm run dev -- --host 0.0.0.0 --port 3008 &

curl -s http://127.0.0.1:8008/health | jq '.data.dependencies'
# 手动 SSE 验收（临时代替 make sse-test）
curl -Ns http://127.0.0.1:8008/api/v1/stream/{task_id}/test

make quick-gate-local   # 类型 + 后端 smoke + 前端组件 + 结构校验
# 手动 OpenAPI 校验（临时代替 make openapi-check-stream）
curl -s http://127.0.0.1:8008/api/openapi.json | jq '.paths["/api/v1/stream/{task_id}/test"]'
```
- 手动 SSE 验收预期输出：`event: connected` → `event: progress`（至少两次，示例 33/66）→ `event: completed`。若停留在 `progress`，表示 Celery 队列或任务执行异常。
- 手动 OpenAPI 校验预期输出：应返回一个包含 `get` 配置的对象；若为 `null` 或缺少该 key，表示路由注册或文档生成出现回归。
- 如端口冲突：执行 `make kill-port-8008 && make kill-port-3008` 后重试。
- 启动失败优先排查 `.env` 缺失、Docker 未跑、数据库未迁移。

**阶段B执行状态与后续动作**
1. `Makefile` 已补齐：`env-check`、`kill-port-8008`、`kill-port-3008`、`dev-up`、`dev-down`、`sse-test`、`openapi-check-stream`、`sanity-bootstrap`。当前 `dev-up` 复用 `start-dev.sh`，`env-check` 支持 `RSS_ALLOW_PYTHON_MISMATCH=1` / `RSS_ALLOW_NODE_MISMATCH=1` 以兼容非标准本地版本。
2. 现有后端实现限制：`/api/v1/stream/{task_id}/test` 仅返回 `connected` + 心跳，在未触发真实任务时不会发送 `completed`；`/api/openapi.json` 需要鉴权或将返回 401/超时。执行命令时会给出警告，需要在后端实现阶段补齐这两个端点（可通过临时 token 或在开发模式关闭鉴权）。
3. 新命令 `make sse-test` 默认只检查连通性，可通过环境变量 `RSS_ALLOW_OPENAPI_MISMATCH=1` 跳过 OpenAPI 校验，以便在端点修复前继续开发。
4. 待补工作：更新后端测试端点逻辑、配置默认 OpenAPI token，并在 CI 中纳入 `make sanity-bootstrap`。所有缺口必须在正式开发前确认修复，避免再次被回归覆盖。

### 2.3 日常排查重点
- **数据库连接超时**：确认使用 AsyncSession；若见 `invalid dsn: timeout`，检查 `backend/app/core/database.py` 是否仍含 `timeout` 旧参数。
- **SSE 不闭环**：确保 Celery Worker 使用 `-Q analysis_queue,maintenance_queue,cleanup_queue,monitoring_queue` 且 nodename 唯一；必要时重启 worker。当前 `start-dev.sh` 仍采用默认 worker 命令，手动执行时需补全队列与 `-n "celery@$(hostname)-dev-%n"`。
- **多租户隔离**：本地测试时用不同 `tenant_id`，避免错用宿主机 PostgreSQL。
- **命令缺口**：在 Make 目标补齐前，统一使用本节手动命令或 `./start-dev.sh` 启动；并记录执行结果，以便后续在 Makefile 中固化。

---

## 3. PRD 驱动的 0-1 实施节奏（真实 API）

### Phase 0 基线（Day 0-0.5）
- 跑通 2.2 中的启动闭环，记录成功命令输出。
- 阅读 `docs/PRD/PRD-INDEX.md` 的 PRD-代码-测试矩阵，明确每阶段出口标准。

### Phase 1 数据基础（Day 1-2）
- 实现 / 校准 `backend/app/models`、`backend/alembic`，同步更新 Pydantic `schemas`。
- 执行 `pytest backend/tests/test_database_schema.py` 与 `make backend-smoke`，确保字段、索引、约束与 PRD-01 一致。
- 避坑：禁止引入 `Dict[str, Any]` 做临时结构；多租户隔离必须在模型层落实。

### Phase 2 核心服务（Day 3-6）
- **API/SSE (PRD-02)**：聚焦 `backend/app/api/v1`, `core/sse.py`；确保流式事件带 `status` 字段。
- **任务系统 (PRD-04)**：完善 `backend/app/tasks/`、Celery 队列配置、回退策略。
- **分析引擎 (PRD-03)**：聚焦 `backend/app/services/analysis_engine.py` 与相关算法目录，确保缓存优先、DB 超时可中断。
- 必跑测试：`pytest backend/tests/test_feedback_events_api.py`、`pytest backend/tests/test_task_integration.py`、`pytest backend/tests/test_analysis_tasks.py`。
- 避坑：状态查询必须先查 Redis 缓存再回 DB；禁止在 FastAPI 路由中使用同步 Session。

### Phase 3 用户界面与认证（Day 7-10）
- **认证 (PRD-06)**：更新 `backend/app/services/auth_service.py`、`frontend/src/services/auth.service.ts`；JWT 多租户隔离需端到端验证。
- **前端交互 (PRD-05)**：实现 Input → Waiting → Report 流程。默认直连真实 SSE，禁用 Mock。
- 测试：`pytest backend/tests/test_jwt_auth.py`、`pytest backend/tests/test_v0_auth_integration.py`、`npm run type-check`、`npm run test`。
- 避坑：前端状态管理避免 `useState<any>`；SSE 事件需根据后端 `status` 更新，无需再做 type 映射。

### Phase 4 运维与监控（Day 11-12）
- 完成 `backend/app/api/v1/endpoints/admin_*`、`backend/app/services/admin/`、`frontend/src/pages/admin/`。
- 校准 Celery 监控、日志、热更新流程，参考 `docs/handbook/运维手册-日常起停与验收.md`。
- 测试：`pytest backend/tests/test_task_monitoring.py`、`pytest backend/tests/test_feedback_events_api.py`。

### Phase 5 质量与验收（Day 13-15）
- 收敛 `tests/` 下的冒烟/集成/性能用例，确保 `make quick-gate-local` 与 `pytest backend/tests/services/test_signal_to_report_integration.py::test_signal_to_report_chain_builds_consistent_report -q` 常绿。
- 注入故障（Redis 掉线、任务失败）验证恢复策略；执行 OpenAPI 校验保持契约完整。

---

### 阶段执行工作表（Stage C）

| 阶段 | 关键输入文档 / PRD | 主要动作与命令 | 产出 / 验收 | 备注 |
|------|--------------------|----------------|-------------|------|
| Phase 0 基线 | `docs/PRD/PRD-INDEX.md`、本指南第 2 章 | `make env-check`（必要时设置 `RSS_ALLOW_PYTHON_MISMATCH=1` / `RSS_ALLOW_NODE_MISMATCH=1`）<br>`make dev-up` → 保存 `/tmp/dev-up.log` 或复制到 `reports/phase-log/phase0.md`<br>`make sse-test`（当前仅验证 connected；警告可忽略）<br>`RSS_ALLOW_OPENAPI_MISMATCH=1 make openapi-check-stream` 直到 PRD-08 修复<br>`make sanity-bootstrap` | 成功运行日志存档于 `reports/phase-log/`，使用 `phase-template.md` 记录临时变量、命令输出 | 若命令失败，优先检查 `.env`、Docker、端口占用；SSE / OpenAPI 缺陷需在 Phase 2 / 5 修复 |
| Phase 1 数据基础 | PRD-01、`docs/strategy/代码库完整性分析报告-2025-09-26.md` | 设计并实现 SQLAlchemy 模型 + Alembic 迁移<br>`pytest backend/tests/test_database_schema.py`<br>`make backend-smoke` | 数据库结构迁移脚本、测试报告；更新 `docs/handbook/本地运行验收执行方案` Phase 1 条目 | 禁止 `Dict[str, Any]`，多租户隔离必须在模型层完成 |
| Phase 2 核心服务 | PRD-02、PRD-03、PRD-04、`docs/strategy/系统级重构方案-黄金路径稳定化与可中断超时.md` | 实现 API / SSE / Celery / 分析引擎<br>`pytest backend/tests/test_feedback_events_api.py`<br>`pytest backend/tests/test_task_integration.py`<br>`pytest backend/tests/test_analysis_tasks.py`<br>`make sse-test`（修复后应无警告） | 修复后的 SSE 测试端点返回完整事件；更新 PRD-02 文档和本指南脚注，移除对 `RSS_ALLOW_OPENAPI_MISMATCH` 的依赖计划 | 必须补齐 `/api/v1/stream/{task_id}/test` 的 progress/completed 事件；记录异常与解决方案 |
| Phase 3 用户界面 | PRD-05、PRD-06、`docs/handbook/前端像素级还原强执行计划.md` | 实现 React SPA + 认证整合<br>`npm run type-check`、`npm run test`<br>`pytest backend/tests/test_jwt_auth.py`<br>`pytest backend/tests/test_v0_auth_integration.py` | 前后端联调日志、SSE 客户端稳定输出；更新前端文档和 API 合同 | 禁用 Mock：确认 `.env` 中 `VITE_USE_MOCK_API=false`；验证 JWT 多租户隔离 |
| Phase 4 运维管理 | PRD-07、`docs/handbook/运维手册-日常起停与验收.md` | 实现 Admin 面板与监控接口<br>`pytest backend/tests/test_task_monitoring.py`<br>`pytest backend/tests/test_feedback_events_api.py`<br>验证 Celery 队列、日志、热更新 | 运维手册更新、热更新验证记录 | 确保 `start-dev.sh` 与 Make 命令同步；监控脚本纳入 sanity-bootstrap |
| Phase 5 质量保证 | PRD-08、`docs/standards/QUALITY-GATE-RULES.md` | `make quick-gate-local`<br>`make openapi-check-stream`（修复后取消临时变量）<br>`pytest backend/tests/services/test_signal_to_report_chain_builds_consistent_report -q`<br>故障注入 / 性能基线脚本 | Quick Gate 报告、故障注入与性能结果；更新 `docs/reports/` | 需恢复 OpenAPI 无鉴权访问或提供默认 token；CI 引入 `make sanity-bootstrap` 作为门禁 |

> 建议将每阶段的执行记录集中存档（例如 `reports/phase-log/phase-*.md`），并同步更新 PRD-INDEX 对应条目的“主要输出”章节。

## 4. 高频踩坑清单（持续维护）

| 场景 | 典型坑点 | 规避方法 |
|------|----------|----------|
| Make 命令缺口 | `make env-check/dev-up/sse-test` 等尚未实现，文档指令执行失败 | 在 Makefile 补齐目标前，使用 2.2 列出的手动流程或 `./start-dev.sh`；每次执行都记录终端输出并提交，待目标补齐后改用 Make 命令 |
| 端口残留 | `make kill-port-8008/3008` 指令曾缺失，旧进程占用导致启动失败 | 已补齐对应目标，执行 `make kill-port-8008 && make kill-port-3008` 即可清理；保留 `lsof` 手动命令作为兜底 |
| SSE 测试端点 | `/api/v1/stream/{task_id}/test` 仅返回 connected + 心跳，未发送 completed | 后端需要为测试任务补充完整事件；在修复前，`make sse-test` 仅提示警告，不视为失败 |
| OpenAPI 校验 | `/api/openapi.json` 需鉴权或返回超时，命令会报错 | 提供本地默认 token 或临时设置 `RSS_ALLOW_OPENAPI_MISMATCH=1` 跳过校验；后端实现阶段需解决鉴权/超时 |
| 数据库连接 | 将 `asyncio.timeout` 放错位置导致事务不可中断 | 调整至 `async with asyncio.timeout(...): async with session.begin()`（参考 `backend/app/core/db_manager.py`） |
| Celery 队列 | Worker 未绑定指定队列，任务滞留 | 启动命令固定 `-Q analysis_queue,maintenance_queue,cleanup_queue,monitoring_queue`，并使用唯一 `-n` |
| SSE 流程 | 事件结构不一致导致前端 fallback | 后端事件 payload 必含 `status`，前端直接消费；必要时同步更新 `frontend/src/services/sse.service.ts` |
| 配置污染 | 使用宿主机 Postgres/Redis 导致数据错乱 | 所有连接指向 127.0.0.1 映射端口，禁用 localhost/::1 |
| 类型逃逸 | 临时代码引入 `Any`、`Dict[str, Any]` | 立即用 TypedDict / Pydantic 定义结构；违反者阻塞在质量门 |
| Mock 依赖 | 前端沿用 Mock API，联调崩溃 | 所有 Feature 分支确认 `.env` 中 mock 关闭；联调前手动验证 SSE 路径 |

---

## 5. 每日 Checklist 与命令速查

### 每日收工 Checklist
- [ ] 运行 `make quick-gate-local`，确认类型、测试、结构全部通过。
- [ ] 健康检查 `curl -s http://127.0.0.1:8008/health | jq '.data.dependencies'`。
- [ ] 记录当日变更影响的 PRD、文档并更新对应章节。
- [ ] 提交前执行 `pre-commit run --all-files`，清理临时脚本与冗余文件。

### 命令速查
| 目标 | 命令 |
|------|------|
| 安装依赖 | `make install` |
| 校验基础环境 | `python3 --version` / `node --version`（等待 `make env-check` 补齐） |
| 重启后端 | `pkill -f "uvicorn.*app.main" || true` → `cd backend && ./venv/bin/uvicorn app.main:app --reload`（等待 `make backend-hard-restart` 补齐） |
| 启动全栈 | `./start-dev.sh` 或按 2.2 手动执行（等待 `make dev-up` 补齐） |
| 健康检查 | `curl -s http://127.0.0.1:8008/health | jq '.data.dependencies'` |
| SSE 验收 | `curl -Ns http://127.0.0.1:8008/api/v1/stream/{task_id}/test`（等待 `make sse-test` 补齐） |
| 质量门 | `make quick-gate-local` |
| OpenAPI 校验 | `curl -s http://127.0.0.1:8008/api/openapi.json | jq '.paths["/api/v1/stream/{task_id}/test"]'`（等待 `make openapi-check-stream` 补齐） |
| 后端重点测试 | `pytest backend/tests/test_task_integration.py` |
| SSE 端到端测试 | `pytest backend/tests/services/test_signal_to_report_integration.py::test_signal_to_report_chain_builds_consistent_report -q` |

---

## 6. 持续维护指引

- 所有新需求必须先更新 PRD-INDEX 中的矩阵映射，再实施代码；缺失更新视为流程违规。
- 每周对 `docs/strategy`、`docs/standards`、`docs/handbook` 做一次清点，淘汰过期报告，保持本指南引用文档的时效性。
- 观察质量指标（MyPy 错误、Dict[str, Any] 计数）趋势，必要时设定冲刺内清零目标。
- 发现新坑点或成功经验，立即补充至本文件对应章节，确保团队共享最新 best practice。

> **牢记**：快速交付的前提是可重复的流程、真实的联调与可量化的质量标准。本指南即为“避坑 → 闭环 → 持续进化”的执行蓝图。

---

## 7. 环境稳固与依赖管理（Stage 环节）

### 7.1 初次搭建步骤（Phase 0.1）

| 步骤 | 动作 | 说明 |
|------|------|------|
| 1 | 复制环境变量模板 | `cp .env.example .env`，若无 Docker 配置则参照 `docs/handbook/本地运行验收执行方案-2025-10-07.md` 创建 `docker/postgres/postgresql.conf` 与 `pg_hba.conf` |
| 2 | 安装依赖 | `make install`（后端 venv + 前端依赖）；确认 `backend/venv`、`frontend/node_modules` 建立 |
| 3 | 环境校验 | `make env-check`（必要时设置 `RSS_ALLOW_PYTHON_MISMATCH=1` 和 `RSS_ALLOW_NODE_MISMATCH=1` 暂时放宽版本要求） |
| 4 | 启动基础服务 | `make dev-up`，默认启动 Docker→后端→Celery→前端；日志输出保存到 `/tmp/dev-up.log` 或 `reports/sanity/` |
| 5 | 验证链 | `make sse-test`（目前仅验证连通性）<br>`RSS_ALLOW_OPENAPI_MISMATCH=1 make openapi-check-stream`（待 PRD-08 修复）<br>`make sanity-bootstrap` 汇总结果 |

> 提醒：环境变量 `RSS_ALLOW_*` 只用于临时开发，PRD-02 / PRD-08 完成后必须撤销，CI 中不允许使用。

### 7.2 日常运行 / 清理

| 场景 | 命令 | 备注 |
|------|------|------|
| 清理端口残留 | `make kill-port-8008 && make kill-port-3008` | 依赖 `scripts/dev_utils.py`，若缺失 `lsof` 提醒安装 |
| 停止环境 | `make dev-down` | 同时关闭 Docker/后台进程并清理端口 |
| 重新启动 | `make dev-up` | 保证 `.env` 更新后重新加载 |
| 快速 sanity | `make sanity-bootstrap` | 需确保服务已启动；命令返回警告时记录并处理 |

### 7.3 依赖管理策略

- Python：锁定 3.11；使用 `backend/requirements.txt` 维护依赖版本，升级前在隔离分支验证并运行 `make quick-gate-local`。
- 前端：优先使用 `pnpm`（如未安装则退回 npm）；保持 `package-lock.json` 同步，升级后需运行 `npm run type-check`/`npm run test`。
- Docker：`make env-check` 会提示未安装 docker compose 状态；若使用容器，保持 `docker-compose.yml` 与 `docker/postgres/*` 文件一致。
- 临时变量：`RSS_ALLOW_PYTHON_MISMATCH`、`RSS_ALLOW_NODE_MISMATCH`、`RSS_ALLOW_OPENAPI_MISMATCH` 仅用于当前阶段，需在对应 PRD 实施完成后删除并在指南中更新。

### 7.4 依赖升级/新增流程（建议写入 PRD）

1. 在独立分支执行：更新依赖 → 运行 `make env-check`、`make sanity-bootstrap`、`make quick-gate-local`。
2. 更新文档：在 `docs/strategy` 或 `docs/handbook` 中记录升级原因、兼容性测试结果。
3. 确保 `scripts/dev_utils.py` 与 Make 命令同步（如新增检查项）。
4. CI 集成前，准备 `RSS_ALLOW_*` 迁移计划，确保主分支不依赖临时变量。

### 7.5 常见问题与恢复

- **Python/Node 版本差异**：使用 `pyenv`/`nvm` 或在团队提供统一安装脚本，避免本地反复配置。
- **Docker 数据损坏**：`make dev-down` → `docker compose down -v` → 重新执行 Phase 0 步骤。
- **.env 配置混乱**：规范 `.env.example`，对新增变量同步补充说明；必要时提供 `scripts/gen_env.py` 自动生成。
- **命令与脚本不一致**：任何修改需同时更新 `Makefile`、`start-dev.sh`、指南附录，避免下次回归又被覆盖。

> 建议在 CI（或 pre-merge pipeline）中引入 `make env-check` + `make sanity-bootstrap`，确保环境链路持续可用，避免历史问题再次回归。
