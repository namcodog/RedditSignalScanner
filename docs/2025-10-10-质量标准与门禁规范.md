# Reddit Signal Scanner - 质量标准与门禁规范

> **创建日期**: 2025-10-10
> **目标**: 确保代码质量从第一天开始就达到生产标准
> **原则**: "质量内建，而非事后检查"

---

## 🎯 质量承诺

### 零容忍原则

1. **❌ 类型错误**: mypy --strict必须0错误
2. **❌ 测试失败**: pytest必须100%通过
3. **❌ 类型逃逸**: 禁止`# type: ignore`, `Any`, `Dict[str, Any]`
4. **❌ 格式混乱**: black + isort必须通过
5. **❌ 安全漏洞**: 禁止硬编码密码、SQL注入等

---

## 📋 质量门禁 (Quality Gates)

### Level 1: 本地开发门禁（每次保存）

**自动执行**（IDE配置）:
```json
// .vscode/settings.json
{
  "python.linting.mypyEnabled": true,
  "python.linting.mypyArgs": ["--strict"],
  "editor.formatOnSave": true,
  "python.formatting.provider": "black",
  "[python]": {
    "editor.codeActionsOnSave": {
      "source.organizeImports": true
    }
  }
}
```

**检查项**:
- [ ] MyPy实时检查
- [ ] Black自动格式化
- [ ] isort自动整理导入

### Level 2: 提交前门禁（git commit）

**pre-commit hook** (`.pre-commit-config.yaml`):
```yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.4.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-added-large-files

  - repo: https://github.com/psf/black
    rev: 23.7.0
    hooks:
      - id: black

  - repo: https://github.com/pycqa/isort
    rev: 5.12.0
    hooks:
      - id: isort

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.7.0
    hooks:
      - id: mypy
        args: [--strict, --config-file=mypy.ini]
        additional_dependencies: [types-all]

  - repo: local
    hooks:
      - id: pytest-check
        name: pytest-check
        entry: pytest
        language: system
        pass_filenames: false
        always_run: true
```

**安装**:
```bash
pip install pre-commit
pre-commit install
```

**检查项**:
- [ ] Black格式化
- [ ] isort导入排序
- [ ] MyPy类型检查
- [ ] pytest快速测试（关键模块）

### Level 3: PR门禁（代码评审）

**自动CI检查** (`.github/workflows/quality.yml`):
```yaml
name: Quality Gate

on: [pull_request]

jobs:
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: MyPy类型检查
        run: |
          mypy --strict backend/app backend/tests

      - name: pytest测试
        run: |
          pytest backend/tests --cov=backend.app --cov-report=xml

      - name: 上传覆盖率
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml

      - name: Black格式检查
        run: |
          black backend/app --check

      - name: isort检查
        run: |
          isort backend/app --check
```

**人工Review检查清单**:
- [ ] 代码符合PRD设计
- [ ] 命名清晰有意义
- [ ] 没有过度复杂的逻辑
- [ ] 测试覆盖充分
- [ ] 文档同步更新

### Level 4: 发布门禁（部署前）

**完整验收**:
```bash
#!/bin/bash
# scripts/release_gate.sh

echo "===== 发布质量门禁 ====="

# 1. 完整类型检查
echo "\n[1/6] 完整类型检查..."
mypy --strict backend/app backend/tests frontend/src
if [ $? -ne 0 ]; then
    echo "❌ 类型检查失败"
    exit 1
fi

# 2. 完整测试套件
echo "\n[2/6] 完整测试套件..."
pytest backend/tests tests/ --cov=backend.app --cov-report=term-missing --cov-fail-under=80
if [ $? -ne 0 ]; then
    echo "❌ 测试失败或覆盖率不足80%"
    exit 1
fi

# 3. 端到端测试
echo "\n[3/6] 端到端测试..."
pytest tests/integration/test_e2e_flow.py -v
if [ $? -ne 0 ]; then
    echo "❌ E2E测试失败"
    exit 1
fi

# 4. 性能测试
echo "\n[4/6] 性能测试..."
pytest tests/performance/ -v
if [ $? -ne 0 ]; then
    echo "❌ 性能测试失败"
    exit 1
fi

# 5. 安全扫描
echo "\n[5/6] 安全扫描..."
bandit -r backend/app -ll
if [ $? -ne 0 ]; then
    echo "⚠️ 发现安全问题"
fi

# 6. 依赖检查
echo "\n[6/6] 依赖漏洞检查..."
pip-audit
if [ $? -ne 0 ]; then
    echo "⚠️ 发现依赖漏洞"
fi

echo "\n✅ 所有门禁检查通过，可以发布！"
```

---

## 🔍 代码质量标准

### 1. 类型安全标准

#### 必须遵守

```python
# ✅ 正确：完整类型注解
from typing import Dict, List, Optional
from pydantic import BaseModel

class UserRequest(BaseModel):
    email: str
    password: str

async def create_user(
    request: UserRequest,
    db: AsyncSession
) -> Dict[str, str]:
    user = User(email=request.email)
    db.add(user)
    await db.commit()
    return {"user_id": str(user.id)}

# ✅ 正确：可选参数
def process_data(
    data: List[str],
    limit: Optional[int] = None
) -> Dict[str, int]:
    ...
```

#### 绝对禁止

```python
# ❌ 错误：缺少类型注解
def process_data(data):
    ...

# ❌ 错误：使用Any
from typing import Any
def process_data(data: Any) -> Any:
    ...

# ❌ 错误：使用Dict[str, Any]
def process_data() -> Dict[str, Any]:
    ...

# ❌ 错误：type: ignore
result = dangerous_function()  # type: ignore
```

#### MyPy配置

```ini
# mypy.ini
[mypy]
python_version = 3.11
strict = True
warn_return_any = True
warn_unused_configs = True
disallow_untyped_defs = True
disallow_any_unimported = True
disallow_any_expr = True
disallow_any_decorated = True
disallow_any_explicit = True
disallow_any_generics = True
disallow_subclassing_any = True
```

### 2. 测试质量标准

#### 覆盖率要求

| 类型 | 最低覆盖率 | 目标覆盖率 |
|------|----------|----------|
| 单元测试 | 70% | 80%+ |
| 集成测试 | 60% | 70%+ |
| 端到端测试 | 关键路径100% | 所有流程 |

#### 测试命名规范

```python
# ✅ 正确：清晰的测试名称
def test_create_user_with_valid_email_succeeds():
    """测试使用有效邮箱创建用户成功"""
    ...

def test_create_user_with_duplicate_email_raises_conflict():
    """测试使用重复邮箱创建用户返回冲突错误"""
    ...

# ❌ 错误：模糊的测试名称
def test_user():
    ...

def test_case_1():
    ...
```

#### 测试结构（AAA模式）

```python
def test_analyze_task_creates_task_and_returns_id():
    # Arrange (准备)
    request = AnalyzeRequest(product_description="Test product")

    # Act (执行)
    response = client.post("/api/analyze", json=request.dict())

    # Assert (断言)
    assert response.status_code == 201
    assert "task_id" in response.json()
    assert UUID(response.json()["task_id"])  # 验证是有效UUID
```

### 3. 代码格式标准

#### Black配置

```toml
# pyproject.toml
[tool.black]
line-length = 88
target-version = ['py311']
include = '\.pyi?$'
```

#### isort配置

```toml
# pyproject.toml
[tool.isort]
profile = "black"
multi_line_output = 3
include_trailing_comma = true
force_grid_wrap = 0
use_parentheses = true
ensure_newline_before_comments = true
line_length = 88
```

#### 行长度

- Python: 88字符（Black默认）
- TypeScript/JavaScript: 80字符
- SQL: 100字符

### 4. 命名规范

#### Python

```python
# 模块/包: snake_case
import user_service
from backend.app.models import user_model

# 类: PascalCase
class UserService:
    pass

class AnalysisEngine:
    pass

# 函数/变量: snake_case
def create_user(email: str) -> User:
    user_id = generate_uuid()
    ...

# 常量: UPPER_SNAKE_CASE
MAX_RETRY_ATTEMPTS = 3
DEFAULT_TIMEOUT = 30

# 私有成员: _leading_underscore
class MyClass:
    def __init__(self):
        self._private_var = 10

    def _private_method(self):
        pass
```

#### TypeScript

```typescript
// 接口/类型: PascalCase
interface UserResponse {
  userId: string;
  email: string;
}

// 类: PascalCase
class ApiClient {
  ...
}

// 函数/变量: camelCase
function createUser(email: string): Promise<User> {
  const userId = generateUuid();
  ...
}

// 常量: UPPER_SNAKE_CASE
const MAX_RETRY_ATTEMPTS = 3;

// React组件: PascalCase
export function InputPage() {
  ...
}
```

### 5. 文档标准

#### Python Docstring（Google风格）

```python
def analyze_product(
    product_description: str,
    max_communities: int = 20
) -> Dict[str, Any]:
    """分析产品描述并生成洞察报告.

    Args:
        product_description: 产品描述文本，至少10个字符
        max_communities: 分析的最大社区数量，默认20

    Returns:
        包含分析结果的字典，格式：
        {
            'insights': {...},
            'sources': {...},
            'confidence_score': 0.85
        }

    Raises:
        ValueError: 如果product_description太短
        RedditAPIException: 如果Reddit API调用失败

    Example:
        >>> result = analyze_product("AI note-taking app")
        >>> result['confidence_score']
        0.85
    """
    ...
```

#### TypeScript JSDoc

```typescript
/**
 * 创建分析任务
 *
 * @param description - 产品描述，10-2000字符
 * @returns Promise包含任务ID和SSE端点
 * @throws {ApiError} 如果请求失败
 *
 * @example
 * ```ts
 * const result = await createAnalysisTask("AI app");
 * console.log(result.taskId);
 * ```
 */
async function createAnalysisTask(
  description: string
): Promise<AnalyzeResponse> {
  ...
}
```

---

## 📊 质量指标追踪

### 每周质量报告模板

```markdown
## 质量周报 (Week X, YYYY-MM-DD)

### 类型安全
- MyPy错误数: X个（目标:0）
- 趋势: ↑/↓/→

### 测试覆盖率
- 单元测试: X% (目标: >80%)
- 集成测试: X% (目标: >70%)
- E2E测试: X% (目标: 关键路径100%)

### 代码质量
- 新增代码行数: X行
- 新增测试行数: X行
- 测试/代码比: X%

### Bug统计
- 新发现bug: X个
- 已修复bug: X个
- 待修复bug: X个

### 性能指标
- API响应时间 (P95): Xms (目标: <200ms)
- 分析完成时间 (P95): Xs (目标: <300s)

### 技术债务
- TODO数量: X个
- FIXME数量: X个
```

### 质量趋势图表

使用工具：
- **Coverage.py**: 测试覆盖率
- **MyPy**: 类型错误趋势
- **pytest-benchmark**: 性能基准
- **SonarQube**: 代码质量综合评分

---

## 🚨 质量问题升级机制

### 问题级别

| 级别 | 定义 | 响应时间 | 处理方式 |
|------|------|---------|---------|
| P0-紧急 | 类型检查失败、测试全红 | 立即 | 阻止所有开发，全员修复 |
| P1-严重 | 覆盖率<60%、性能下降>20% | 4小时 | 暂停新功能，优先修复 |
| P2-重要 | 单个模块覆盖率<70% | 1天 | 纳入当前Sprint |
| P3-一般 | 代码格式问题、文档缺失 | 1周 | 纳入Backlog |

### 升级流程

```
发现问题 → 评级 → 创建Issue → 分配责任人 → 修复 → Review → 关闭
```

---

## ✅ 质量检查清单（提交PR前）

### 代码checklist

- [ ] 所有函数都有类型注解
- [ ] 没有`# type: ignore`
- [ ] 没有`Any`类型
- [ ] 没有`Dict[str, Any]`
- [ ] MyPy检查通过
- [ ] Black格式化通过
- [ ] isort排序通过

### 测试checklist

- [ ] 新增代码有对应测试
- [ ] 所有测试通过
- [ ] 覆盖率没有下降
- [ ] 测试名称清晰
- [ ] 使用AAA模式

### 文档checklist

- [ ] Docstring完整
- [ ] README更新（如有API变化）
- [ ] CHANGELOG更新
- [ ] PRD符合度确认

### 性能checklist

- [ ] 没有N+1查询
- [ ] 没有阻塞调用（应用asyncio）
- [ ] 大数据集使用分页
- [ ] 合理使用缓存

---

## 🎓 培训与文档

### 新人Onboarding

Day 1:
1. 阅读本质量标准文档
2. 配置开发环境（pre-commit hooks）
3. 运行完整测试套件

Day 2:
1. 修复一个"Good First Issue"
2. 经历完整PR流程
3. 理解质量门禁

### 最佳实践文档

- [Python类型注解最佳实践](docs/best-practices/python-typing.md)
- [测试编写指南](docs/best-practices/testing-guide.md)
- [性能优化checklist](docs/best-practices/performance.md)

---

## 📞 联系与支持

**质量问题反馈**:
- Slack频道: #quality
- 邮件: quality@team.com

**工具支持**:
- MyPy问题: [官方文档](https://mypy.readthedocs.io/)
- pytest问题: [官方文档](https://docs.pytest.org/)

---

**记住**: "质量是设计出来的，不是测试出来的。"

**Let's build it right the first time! 🚀**
