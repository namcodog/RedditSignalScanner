# Reddit Signal Scanner - 本地启动指南

**目标**: 后端运行在 `http://localhost:8006`，前端运行在 `http://localhost:3006`

---

## 📋 前置准备

### 1. 环境要求

- **Python**: 3.11（推荐使用 Homebrew 安装）
- **Node.js**: 16+ 和 npm
- **PostgreSQL**: 14+（本地运行）
- **Redis**: 6+（本地运行）

### 2. 检查环境

```bash
# 检查 Python 版本
/opt/homebrew/bin/python3.11 --version
# 应输出: Python 3.11.x

# 检查 Node.js 版本
node --version
# 应输出: v16.x.x 或更高

# 检查 PostgreSQL 是否运行
psql --version
pg_isready

# 检查 Redis 是否安装
redis-cli --version
```

---

## 🚀 快速启动（推荐）

### 方式一：一键黄金路径（自动启动所有服务）

```bash
# 在项目根目录执行
make dev-golden-path
```

**这个命令会自动完成以下步骤**：
1. 启动 Redis 服务
2. 填充 Redis 测试数据
3. 启动 Celery Worker（后台任务处理）
4. 启动后端服务（FastAPI，端口 8006）
5. 创建测试用户和任务
6. 启动前端服务（Vite，端口 3006）

**启动成功后，你会看到**：
```
✅ 黄金路径启动完成！

📊 服务状态：
   Redis:    ✅ redis://localhost:6379
   Celery:   ✅ tail -f /tmp/celery_worker.log
   Backend:  ✅ http://localhost:8006
   Frontend: ✅ http://localhost:3006

🔗 快速访问：
   前端首页:  http://localhost:3006/
   API 文档:  http://localhost:8006/docs
```

**验收步骤**：
1. 打开浏览器访问 `http://localhost:3006/`（前端首页）
2. 打开浏览器访问 `http://localhost:8006/docs`（后端 API 文档）
3. 在前端输入产品描述，提交分析任务
4. 查看实时进度和分析报告

---

## 🔧 手动启动（分步控制）

如果你想更精细地控制启动过程，可以按以下步骤手动启动：

### 步骤 1: 启动 PostgreSQL

```bash
# 如果使用 Homebrew 安装的 PostgreSQL
brew services start postgresql@14

# 创建数据库（首次运行）
createdb reddit_scanner

# 验证数据库连接
psql -d reddit_scanner -c "SELECT version();"
```

### 步骤 2: 启动 Redis

```bash
# 启动 Redis 服务
make redis-start

# 验证 Redis 连接
redis-cli ping
# 应输出: PONG
```

### 步骤 3: 数据库迁移

```bash
# 进入后端目录
cd backend

# 运行数据库迁移
alembic upgrade head

# 返回项目根目录
cd ..
```

### 步骤 4: 启动 Celery Worker

```bash
# 启动 Celery Worker（后台任务处理）
make celery-start
```

**注意**: Celery Worker 会在前台运行，你需要新开一个终端继续后续步骤。

或者使用后台启动：
```bash
make celery-restart
```

### 步骤 5: 启动后端服务

**新开一个终端**，执行：

```bash
# 启动后端服务（FastAPI，端口 8006）
make dev-backend
```

**验证后端启动成功**：
- 打开浏览器访问 `http://localhost:8006/docs`
- 你应该看到 FastAPI 的 Swagger 文档页面

### 步骤 6: 启动前端服务

**再新开一个终端**，执行：

```bash
# 启动前端服务（Vite，端口 3006）
make dev-frontend
```

**验证前端启动成功**：
- 打开浏览器访问 `http://localhost:3006/`
- 你应该看到 Reddit Signal Scanner 的首页

---

## 🧪 创建测试数据（可选）

如果你想测试完整流程，可以创建测试用户和任务：

```bash
# 创建测试用户和任务
make db-seed-user-task
```

这会创建：
- 测试用户邮箱: `prd-test@example.com`
- 一个已完成的分析任务

---

## 📊 查看服务状态

### 检查所有服务是否运行

```bash
# 检查 Redis
redis-cli ping

# 检查 PostgreSQL
pg_isready

# 检查后端服务
curl http://localhost:8006/

# 检查前端服务
curl http://localhost:3006/

# 检查 Celery Worker
tail -f /tmp/celery_worker.log
```

### 查看日志

```bash
# Celery Worker 日志
tail -f /tmp/celery_worker.log

# 后端日志（如果使用黄金路径启动）
tail -f /tmp/backend_uvicorn.log

# 前端日志（如果使用黄金路径启动）
tail -f /tmp/frontend_vite.log
```

---

## 🛑 停止服务

### 停止所有服务（一键清理）

```bash
# 停止所有端口和服务
make kill-ports && make kill-celery && make kill-redis
```

### 分别停止服务

```bash
# 停止后端服务（端口 8006）
make kill-backend-port

# 停止前端服务（端口 3006）
make kill-frontend-port

# 停止 Celery Worker
make kill-celery

# 停止 Redis
make kill-redis

# 停止 PostgreSQL（Homebrew）
brew services stop postgresql@14
```

---

## ❌ 常见问题排查

### 问题 1: 端口被占用

**错误信息**: `Address already in use` 或 `Port 8006/3006 is already allocated`

**解决方案**:
```bash
# 清理被占用的端口
make kill-ports

# 或者手动清理特定端口
lsof -ti:8006 | xargs kill -9  # 清理后端端口
lsof -ti:3006 | xargs kill -9  # 清理前端端口
```

### 问题 2: PostgreSQL 连接失败

**错误信息**: `could not connect to server: Connection refused`

**解决方案**:
```bash
# 检查 PostgreSQL 是否运行
pg_isready

# 如果未运行，启动 PostgreSQL
brew services start postgresql@14

# 检查数据库是否存在
psql -l | grep reddit_scanner

# 如果不存在，创建数据库
createdb reddit_scanner
```

### 问题 3: Redis 连接失败

**错误信息**: `Error connecting to Redis`

**解决方案**:
```bash
# 启动 Redis
make redis-start

# 验证 Redis 连接
redis-cli ping
```

### 问题 4: Celery Worker 启动失败

**错误信息**: `celery: command not found` 或 Worker 无法连接到 Redis

**解决方案**:
```bash
# 检查 backend/.env 文件是否存在
ls -la backend/.env

# 检查 Redis 是否运行
redis-cli ping

# 查看 Celery Worker 日志
tail -f /tmp/celery_worker.log

# 重启 Celery Worker
make celery-restart
```

### 问题 5: 前端依赖未安装

**错误信息**: `Cannot find module` 或 `npm ERR!`

**解决方案**:
```bash
# 安装前端依赖
cd frontend
npm install
cd ..
```

### 问题 6: 后端依赖未安装

**错误信息**: `ModuleNotFoundError: No module named 'xxx'`

**解决方案**:
```bash
# 安装后端依赖
cd backend
/opt/homebrew/bin/python3.11 -m pip install -r requirements.txt
cd ..
```

---

## 🎯 验收检查清单

在你验收之前，请确保以下所有项都正常：

### 后端验收（http://localhost:8006）

- [ ] 访问 `http://localhost:8006/` 返回 `{"message": "Reddit Signal Scanner API"}`
- [ ] 访问 `http://localhost:8006/docs` 显示 Swagger API 文档
- [ ] 访问 `http://localhost:8006/openapi.json` 返回 OpenAPI 规范
- [ ] API 文档中可以看到以下端点：
  - `POST /api/tasks/` - 创建分析任务
  - `GET /api/tasks/{task_id}` - 获取任务状态
  - `GET /api/tasks/{task_id}/report` - 获取分析报告
  - `GET /api/tasks/{task_id}/stream` - SSE 实时进度

### 前端验收（http://localhost:3006）

- [ ] 访问 `http://localhost:3006/` 显示首页
- [ ] 首页有产品描述输入框
- [ ] 首页有提交按钮
- [ ] 可以输入产品描述并提交
- [ ] 提交后跳转到等待页面
- [ ] 等待页面显示实时进度
- [ ] 分析完成后跳转到报告页面

### 服务验收

- [ ] Redis 运行正常（`redis-cli ping` 返回 `PONG`）
- [ ] PostgreSQL 运行正常（`pg_isready` 返回 `accepting connections`）
- [ ] Celery Worker 运行正常（`tail -f /tmp/celery_worker.log` 显示 `ready`）
- [ ] 后端服务运行正常（端口 8006）
- [ ] 前端服务运行正常（端口 3006）

---

## 📝 环境变量配置

### backend/.env

确保 `backend/.env` 文件包含以下配置：

```bash
# Reddit API凭证
REDDIT_CLIENT_ID=USCPQ5QL140Sox3R09YZ1Q
REDDIT_CLIENT_SECRET=e7vTRMdXJIAAgvErHQwfwYpRaen0SQ

# 数据库配置
DATABASE_URL=postgresql+psycopg://postgres:postgres@localhost:5432/reddit_scanner

# Redis配置
REDIS_URL=redis://localhost:6379/5

# Celery配置
CELERY_BROKER_URL=redis://localhost:6379/1
CELERY_RESULT_BACKEND=redis://localhost:6379/2

# Admin 邮箱白名单
ADMIN_EMAILS=prd-test@example.com

# 应用运行环境
APP_ENV=development
```

**注意**: 如果你的 PostgreSQL 用户名/密码不是 `postgres/postgres`，请修改 `DATABASE_URL`。

---

## 🔗 快速访问链接

启动成功后，你可以访问以下链接：

- **前端首页**: http://localhost:3006/
- **后端 API 文档**: http://localhost:8006/docs
- **后端 OpenAPI 规范**: http://localhost:8006/openapi.json
- **后端健康检查**: http://localhost:8006/

---

## 💡 提示

1. **首次启动建议使用黄金路径**: `make dev-golden-path` 会自动完成所有配置
2. **查看实时日志**: 使用 `tail -f /tmp/celery_worker.log` 查看任务处理日志
3. **停止服务**: 使用 `make kill-ports && make kill-celery && make kill-redis` 一键停止所有服务
4. **重启服务**: 先停止所有服务，再重新运行 `make dev-golden-path`

---

**准备好了吗？现在就运行 `make dev-golden-path` 开始验收吧！** 🚀

