# æ•°æ®å­˜å‚¨è®¾è®¡æ·±åº¦åˆ†ææŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2025-10-24  
**åˆ†æèŒƒå›´**: æ•°æ®å­˜å‚¨ç»“æ„ã€å†·çƒ­åˆ†ç¦»ã€SCD2å®ç°ã€æ•°æ®æµå‘ã€è®¾è®¡é—®é¢˜è¯†åˆ«  
**æ•°æ®åº“ç‰ˆæœ¬**: `d18c3d80c75e` (head)

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

### ğŸ¯ åˆ†æç»“è®º

**å­˜å‚¨æ¶æ„**: âœ… **å†·çƒ­åˆ†ç¦» + SCD2ç‰ˆæœ¬æ§åˆ¶ + ç‰©åŒ–è§†å›¾ä¼˜åŒ–**  
**è®¾è®¡å®Œæ•´æ€§**: âš ï¸ **70%å®Œæ•´** (æ¶æ„è®¾è®¡ä¼˜ç§€,ä½†å®æ–½ä¸å®Œæ•´)  
**å‘ç°é—®é¢˜**: ğŸ”´ **7ä¸ªä¸¥é‡é—®é¢˜** + ğŸŸ¡ **5ä¸ªä¼˜åŒ–å»ºè®®**

---

## 1ï¸âƒ£ æ•°æ®å­˜å‚¨ç»“æ„å…¨æ™¯

### 1.1 å­˜å‚¨åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ•°æ®å­˜å‚¨ä¸‰å±‚æ¶æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Layer 1: Redis ç¼“å­˜ (å†…å­˜)                                 â”‚
â”‚  â”œâ”€ TTL: 24å°æ—¶                                             â”‚
â”‚  â”œâ”€ ç”¨é€”: å®æ—¶åˆ†æã€å¿«é€Ÿå“åº”                                 â”‚
â”‚  â””â”€ ç®¡ç†: CacheManager                                      â”‚
â”‚                                                             â”‚
â”‚  Layer 2: posts_hot (çƒ­å­˜å‚¨)                                â”‚
â”‚  â”œâ”€ TTL: 24-72å°æ—¶                                          â”‚
â”‚  â”œâ”€ ç”¨é€”: è¿‘æœŸæ•°æ®åˆ†æã€çœ‹æ¿                                 â”‚
â”‚  â”œâ”€ ç­–ç•¥: è¦†ç›–å¼åˆ·æ–°                                         â”‚
â”‚  â””â”€ è¡¨: posts_hot (11å­—æ®µ,ç®€åŒ–ç‰ˆ)                           â”‚
â”‚                                                             â”‚
â”‚  Layer 3: posts_raw (å†·å­˜å‚¨)                                â”‚
â”‚  â”œâ”€ ä¿ç•™: 90å¤©æ»šåŠ¨çª—å£                                       â”‚
â”‚  â”œâ”€ ç”¨é€”: ç®—æ³•è®­ç»ƒã€è¶‹åŠ¿åˆ†æã€å›æµ‹                           â”‚
â”‚  â”œâ”€ ç­–ç•¥: å¢é‡ç´¯ç§¯ + SCD2ç‰ˆæœ¬æ§åˆ¶                            â”‚
â”‚  â””â”€ è¡¨: posts_raw (23å­—æ®µ,å®Œæ•´ç‰ˆ)                           â”‚
â”‚                                                             â”‚
â”‚  Layer 3.5: posts_latest (ç‰©åŒ–è§†å›¾)                         â”‚
â”‚  â”œâ”€ æ¥æº: posts_raw WHERE is_current = TRUE                â”‚
â”‚  â”œâ”€ ç”¨é€”: å¿«é€ŸæŸ¥è¯¢æœ€æ–°ç‰ˆæœ¬                                   â”‚
â”‚  â””â”€ åˆ·æ–°: å®šæœŸåˆ·æ–° (è®¾è®¡ä¸­,æœªå®æ–½)                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒè¡¨ç»“æ„

#### posts_raw (å†·åº“)

**ä¸»é”®ç­–ç•¥**: 
- âœ… å½“å‰: `id BIGSERIAL PRIMARY KEY`
- âœ… å”¯ä¸€çº¦æŸ: `(source, source_post_id, version)`
- âœ… ç´¢å¼•: 8ä¸ªç´¢å¼• (æ—¶é—´ã€ç¤¾åŒºã€å“ˆå¸Œã€GIN)

**SCD2å­—æ®µ**:
- `version`: ç‰ˆæœ¬å· (æ¯æ¬¡ç¼–è¾‘+1)
- `is_current`: æ˜¯å¦å½“å‰ç‰ˆæœ¬
- `valid_from`: ç‰ˆæœ¬ç”Ÿæ•ˆæ—¶é—´
- `valid_to`: ç‰ˆæœ¬å¤±æ•ˆæ—¶é—´ (é»˜è®¤ 9999-12-31)

**å»é‡æœºåˆ¶**:
- `text_norm_hash`: æ–‡æœ¬å½’ä¸€åŒ–å“ˆå¸Œ (MD5)
- è§¦å‘å™¨: `trg_fill_normalized_fields` è‡ªåŠ¨å¡«å……

**å­—æ®µç»Ÿè®¡**: 23ä¸ªå­—æ®µ
- ä¸»é”®: 4ä¸ª (id, source, source_post_id, version)
- æ—¶é—´æˆ³: 4ä¸ª (created_at, fetched_at, valid_from, valid_to)
- å†…å®¹: 6ä¸ª (title, body, body_norm, text_norm_hash, url, lang)
- å…ƒæ•°æ®: 5ä¸ª (subreddit, score, num_comments, is_deleted, edit_count)
- ä½œè€…: 2ä¸ª (author_id, author_name)
- JSONB: 1ä¸ª (metadata)
- SCD2: 1ä¸ª (is_current)

#### posts_hot (çƒ­ç¼“å­˜)

**ä¸»é”®ç­–ç•¥**:
- âœ… å½“å‰: `id BIGSERIAL PRIMARY KEY`
- âœ… å”¯ä¸€çº¦æŸ: `(source, source_post_id)`
- âœ… ç´¢å¼•: 5ä¸ªç´¢å¼• (æ—¶é—´ã€ç¤¾åŒºã€è¿‡æœŸã€GIN)

**TTLæœºåˆ¶**:
- `expires_at`: è¿‡æœŸæ—¶é—´ (é»˜è®¤ cached_at + 24å°æ—¶)
- å®šæœŸæ¸…ç†: `cleanup_expired_hot_cache()` (è®¾è®¡ä¸­,æœªå®æ–½)

**å­—æ®µç»Ÿè®¡**: 12ä¸ªå­—æ®µ (ç®€åŒ–ç‰ˆ)
- ä¸»é”®: 3ä¸ª (id, source, source_post_id)
- æ—¶é—´æˆ³: 3ä¸ª (created_at, cached_at, expires_at)
- å†…å®¹: 2ä¸ª (title, body)
- å…ƒæ•°æ®: 3ä¸ª (subreddit, score, num_comments)
- JSONB: 1ä¸ª (metadata)

#### posts_latest (ç‰©åŒ–è§†å›¾)

**å®šä¹‰**: `SELECT * FROM posts_raw WHERE is_current = TRUE`

**ç´¢å¼•**: 4ä¸ªç´¢å¼•
- `idx_posts_latest_created_at`: æ—¶é—´æŸ¥è¯¢
- `idx_posts_latest_subreddit`: ç¤¾åŒºæŸ¥è¯¢
- `idx_posts_latest_text_hash`: å»é‡æŸ¥è¯¢
- `idx_posts_latest_unique`: å”¯ä¸€æ€§ä¿è¯

**åˆ·æ–°ç­–ç•¥**: âš ï¸ **æœªå®æ–½** (è®¾è®¡ä¸­æœ‰ `refresh_posts_latest()` å‡½æ•°,ä½†æœªè°ƒç”¨)

---

## 2ï¸âƒ£ æ•°æ®æµå‘å®Œæ•´æ¢³ç†

### 2.1 æ•°æ®å†™å…¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Reddit API   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IncrementalCrawler.crawl_community_incremental()         â”‚
â”‚ â”œâ”€ 1. è·å–æ°´ä½çº¿ (community_cache.last_seen_post_id)     â”‚
â”‚ â”œâ”€ 2. æŠ“å–æ–°å¸–å­ (Reddit API)                            â”‚
â”‚ â”œâ”€ 3. è¿‡æ»¤ (åªä¿ç•™æ–°äºæ°´ä½çº¿çš„)                          â”‚
â”‚ â””â”€ 4. åŒå†™ (_dual_write)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ _dual_write() - å†·çƒ­åŒå†™ç­–ç•¥                             â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ 1. å†™å†·åº“ (å…ˆ)       â”‚    â”‚ 2. å†™çƒ­ç¼“å­˜ (å)     â”‚    â”‚
â”‚  â”‚ _upsert_to_cold_    â”‚    â”‚ _upsert_to_hot_     â”‚    â”‚
â”‚  â”‚ storage()           â”‚    â”‚ cache()             â”‚    â”‚
â”‚  â”‚                     â”‚    â”‚                     â”‚    â”‚
â”‚  â”‚ â”œâ”€ æ£€æŸ¥æ˜¯å¦å­˜åœ¨      â”‚    â”‚ â”œâ”€ è¦†ç›–å¼æ›´æ–°        â”‚    â”‚
â”‚  â”‚ â”œâ”€ æ–°å¢: version=1  â”‚    â”‚ â”œâ”€ æ›´æ–° expires_at  â”‚    â”‚
â”‚  â”‚ â”œâ”€ æ›´æ–°: version+1  â”‚    â”‚ â””â”€ æ›´æ–°æ‰€æœ‰å­—æ®µ      â”‚    â”‚
â”‚  â”‚ â””â”€ é‡å¤: è·³è¿‡        â”‚    â”‚                     â”‚    â”‚
â”‚  â”‚                     â”‚    â”‚                     â”‚    â”‚
â”‚  â”‚ â–¼                   â”‚    â”‚ â–¼                   â”‚    â”‚
â”‚  â”‚ posts_raw           â”‚    â”‚ posts_hot           â”‚    â”‚
â”‚  â”‚ (å¢é‡ç´¯ç§¯)           â”‚    â”‚ (è¦†ç›–åˆ·æ–°)           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ›´æ–°æ°´ä½çº¿ (community_cache)                          â”‚
â”‚ â”œâ”€ last_seen_post_id                                    â”‚
â”‚ â”œâ”€ last_seen_created_at                                 â”‚
â”‚ â”œâ”€ total_posts_fetched                                  â”‚
â”‚ â””â”€ dedup_rate                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®è¯»å–æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AnalysisEngine.run_analysis()                            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DataCollectionService.collect_posts()                    â”‚
â”‚ (Cache-First ç­–ç•¥)                                       â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚ 1. Redis ç¼“å­˜ (ä¼˜å…ˆ) â”‚                                â”‚
â”‚  â”‚ CacheManager.get_   â”‚                                â”‚
â”‚  â”‚ cached_posts()      â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚            â”‚ âŒ Miss                                     â”‚
â”‚            â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚ 2. Reddit API (å®æ—¶) â”‚                                â”‚
â”‚  â”‚ RedditAPIClient.    â”‚                                â”‚
â”‚  â”‚ fetch_subreddit_    â”‚                                â”‚
â”‚  â”‚ posts()             â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚            â”‚                                             â”‚
â”‚            â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚ 3. å†™å…¥ Redis ç¼“å­˜   â”‚                                â”‚
â”‚  â”‚ CacheManager.set_   â”‚                                â”‚
â”‚  â”‚ cached_posts()      â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ†ææµç¨‹                                                  â”‚
â”‚ â”œâ”€ 1. å…³é”®è¯è¿‡æ»¤ (_filter_posts_by_keywords)             â”‚
â”‚ â”œâ”€ 2. å»é‡ (deduplicate_posts)                          â”‚
â”‚ â”œâ”€ 3. ä¿¡å·æå– (SignalExtractor.extract)                â”‚
â”‚ â””â”€ 4. æœºä¼šè¯„åˆ† (OpportunityScorer.score)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš ï¸ å…³é”®å‘ç°**: 
- âŒ **åˆ†æå¼•æ“æœªä½¿ç”¨ posts_hot/posts_raw**
- âŒ **åˆ†æå¼•æ“åªä½¿ç”¨ Redis + Reddit API**
- âŒ **posts_latest ç‰©åŒ–è§†å›¾ä»æœªè¢«æŸ¥è¯¢**

---

## 3ï¸âƒ£ å­˜å‚¨è®¾è®¡é—®é¢˜è¯†åˆ«

### ğŸ”´ P0 ä¸¥é‡é—®é¢˜ (7ä¸ª)

#### P0-1: ç‰©åŒ–è§†å›¾ posts_latest ä»æœªåˆ·æ–° âš ï¸

**é—®é¢˜**: 
- è®¾è®¡ä¸­æœ‰ `refresh_posts_latest()` å‡½æ•°
- ä½†ä»æœªè¢«è°ƒç”¨,ç‰©åŒ–è§†å›¾æ°¸è¿œæ˜¯ç©ºçš„
- å½“å‰æ•°æ®: `SELECT COUNT(*) FROM posts_latest` = **0 è¡Œ**

**å½±å“**: 
- ç‰©åŒ–è§†å›¾å®Œå…¨æ— ç”¨
- æµªè´¹å­˜å‚¨ç©ºé—´å’Œç´¢å¼•ç»´æŠ¤æˆæœ¬

**è¯æ®**:
```bash
$ psql -c "SELECT COUNT(*) FROM posts_latest"
 total_posts_latest 
--------------------
                  0
```

**ä¿®å¤å»ºè®®**:
1. æ·»åŠ  Celery Beat å®šæ—¶ä»»åŠ¡,æ¯å°æ—¶åˆ·æ–°ä¸€æ¬¡
2. æˆ–è€…åœ¨ `_dual_write()` åè§¦å‘å¢é‡åˆ·æ–°
3. æˆ–è€…åˆ é™¤ç‰©åŒ–è§†å›¾,æ”¹ç”¨æ™®é€šè§†å›¾

---

#### P0-2: çƒ­ç¼“å­˜è¿‡æœŸæ•°æ®ä»æœªæ¸…ç† âš ï¸

**é—®é¢˜**:
- è®¾è®¡ä¸­æœ‰ `cleanup_expired_hot_cache()` å‡½æ•° (åœ¨ SQL è¿ç§»ä¸­)
- ä½†åœ¨ Python ä»£ç ä¸­æœªå®ç°
- `posts_hot` è¡¨ä¼šæ— é™å¢é•¿

**å½±å“**:
- å­˜å‚¨ç©ºé—´æµªè´¹
- æŸ¥è¯¢æ€§èƒ½ä¸‹é™
- TTLæœºåˆ¶å¤±æ•ˆ

**è¯æ®**:
```python
# backend/app/tasks/maintenance_task.py ä¸­æœ‰æ¸…ç†é€»è¾‘
# ä½†åªåœ¨ cleanup_expired_hot_cache_task() ä¸­è°ƒç”¨
# è¯¥ä»»åŠ¡æœªåœ¨ Celery Beat ä¸­é…ç½®
```

**ä¿®å¤å»ºè®®**:
1. åœ¨ `backend/app/core/celery_beat_config.py` æ·»åŠ å®šæ—¶ä»»åŠ¡
2. æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡ `cleanup_expired_hot_cache_task`

---

#### P0-3: å†·åº“90å¤©æ»šåŠ¨çª—å£ä»æœªæ‰§è¡Œ âš ï¸

**é—®é¢˜**:
- è®¾è®¡ä¸­æœ‰ `cleanup_old_posts()` å‡½æ•° (åœ¨ SQL è¿ç§»ä¸­)
- ä½†åœ¨ Python ä»£ç ä¸­æœªå®ç°
- `posts_raw` è¡¨ä¼šæ— é™å¢é•¿

**å½±å“**:
- å­˜å‚¨ç©ºé—´æ— é™å¢é•¿
- æŸ¥è¯¢æ€§èƒ½æŒç»­ä¸‹é™
- è¿èƒŒ"90å¤©æ»šåŠ¨çª—å£"è®¾è®¡åŸåˆ™

**ä¿®å¤å»ºè®®**:
1. å®ç° `cleanup_old_posts_task()` Celery ä»»åŠ¡
2. æ¯å¤©æ‰§è¡Œä¸€æ¬¡,åˆ é™¤ 90 å¤©å‰çš„æ•°æ®

---

#### P0-4: åˆ†æå¼•æ“æœªä½¿ç”¨å†·çƒ­å­˜å‚¨ ğŸ”´

**é—®é¢˜**:
- `AnalysisEngine` åªä½¿ç”¨ Redis + Reddit API
- å®Œå…¨å¿½ç•¥ `posts_hot` å’Œ `posts_raw`
- å†·çƒ­åˆ†ç¦»æ¶æ„å½¢åŒè™šè®¾

**å½±å“**:
- æµªè´¹å­˜å‚¨èµ„æº
- æ— æ³•åˆ©ç”¨å†å²æ•°æ®åšè¶‹åŠ¿åˆ†æ
- æ— æ³•å®ç°"å›æµ‹"åŠŸèƒ½

**è¯æ®**:
```python
# backend/app/services/analysis_engine.py
# _fetch_hot_samples() å’Œ _fetch_cold_samples() å­˜åœ¨
# ä½†åªç”¨äº sample_guard æ£€æŸ¥,ä¸ç”¨äºä¸»åˆ†ææµç¨‹
```

**ä¿®å¤å»ºè®®**:
1. ä¿®æ”¹ `DataCollectionService.collect_posts()`:
   - ä¼˜å…ˆä» `posts_hot` è¯»å– (æœ€è¿‘ 24-72 å°æ—¶)
   - è¡¥è¯» `posts_raw` (æœ€è¿‘ 30 å¤©)
   - æœ€åæ‰è°ƒç”¨ Reddit API
2. å®ç°ä¸‰å±‚ç¼“å­˜ç­–ç•¥: Redis â†’ posts_hot â†’ posts_raw â†’ Reddit API

---

#### P0-5: SCD2ç‰ˆæœ¬æ§åˆ¶æœªæ­£ç¡®å®æ–½ âš ï¸

**é—®é¢˜**:
- `_upsert_to_cold_storage()` ä¸­çš„ SCD2 é€»è¾‘ä¸å®Œæ•´
- æ›´æ–°æ—¶åªå¢åŠ  `version`,æœªè®¾ç½®æ—§ç‰ˆæœ¬çš„ `valid_to` å’Œ `is_current=FALSE`

**å½±å“**:
- å¤šä¸ªç‰ˆæœ¬çš„ `is_current` éƒ½æ˜¯ `TRUE`
- `posts_latest` ç‰©åŒ–è§†å›¾ä¼šåŒ…å«é‡å¤æ•°æ®
- æ— æ³•æ­£ç¡®è¿½è¸ªç‰ˆæœ¬å†å²

**è¯æ®**:
```python
# backend/app/services/incremental_crawler.py:341-370
stmt = stmt.on_conflict_do_update(
    index_elements=["source", "source_post_id", "version"],
    set_={
        "score": excluded.score,
        "num_comments": excluded.num_comments,
        "fetched_at": excluded.fetched_at,
        "version": PostRaw.version + 1,  # âŒ åªå¢åŠ ç‰ˆæœ¬å·
    },
)
# âŒ ç¼ºå°‘: è®¾ç½®æ—§ç‰ˆæœ¬ is_current=FALSE, valid_to=NOW()
```

**ä¿®å¤å»ºè®®**:
1. åœ¨ `on_conflict_do_update` å‰,å…ˆæ›´æ–°æ—§ç‰ˆæœ¬:
   ```python
   UPDATE posts_raw 
   SET is_current = FALSE, valid_to = NOW()
   WHERE source = ? AND source_post_id = ? AND is_current = TRUE
   ```
2. ç„¶åæ’å…¥æ–°ç‰ˆæœ¬ (version+1, is_current=TRUE)

---

#### P0-6: å»é‡å“ˆå¸Œå¯èƒ½å†²çª âš ï¸

**é—®é¢˜**:
- `text_norm_hash` ä½¿ç”¨ MD5 å“ˆå¸Œ
- MD5 å·²çŸ¥å­˜åœ¨ç¢°æ’é£é™©
- å¯¹äºå¤§è§„æ¨¡æ•°æ®,å¯èƒ½å¯¼è‡´è¯¯åˆ¤

**å½±å“**:
- ä¸åŒå†…å®¹è¢«è¯¯åˆ¤ä¸ºé‡å¤
- ä¸¢å¤±æœ‰æ•ˆæ•°æ®

**ä¿®å¤å»ºè®®**:
1. æ”¹ç”¨ SHA-256 æˆ– BLAKE2
2. æˆ–è€…ä½¿ç”¨ `(text_norm_hash, title, body)` ç»„åˆå»é‡

---

#### P0-7: æ•°æ®åº“è¿ç§»ä¸ Alembic ä¸ä¸€è‡´ ğŸ”´

**é—®é¢˜**:
- `backend/migrations/001_cold_hot_storage.sql` æ˜¯æ‰‹åŠ¨ SQL è¿ç§»
- ä½† Alembic ç‰ˆæœ¬å†å²ä¸­æ²¡æœ‰å¯¹åº”çš„è¿ç§»æ–‡ä»¶
- å¯¼è‡´ `posts_raw`, `posts_hot`, `posts_latest` ä¸åœ¨ Alembic ç®¡ç†ä¸‹

**å½±å“**:
- `alembic check` ä¼šæŠ¥é”™
- æ— æ³•å›æ»šè¿ç§»
- å›¢é˜Ÿåä½œæ—¶å¯èƒ½å‡ºç°æ•°æ®åº“ä¸ä¸€è‡´

**è¯æ®**:
```bash
$ find backend/alembic/versions -name "*cold_hot*"
# æ— ç»“æœ

$ ls backend/migrations/
001_cold_hot_storage.sql  # âŒ æ‰‹åŠ¨ SQL,æœªçº³å…¥ Alembic
```

**ä¿®å¤å»ºè®®**:
1. å°† `001_cold_hot_storage.sql` è½¬æ¢ä¸º Alembic è¿ç§»
2. æˆ–è€…åˆ é™¤ SQL æ–‡ä»¶,ç”¨ Alembic é‡æ–°ç”Ÿæˆè¿ç§»

---

### ğŸŸ¡ P1 ä¼˜åŒ–å»ºè®® (5ä¸ª)

#### P1-1: posts_hot ç¼ºå°‘ author å­—æ®µ

**é—®é¢˜**: çƒ­ç¼“å­˜æ²¡æœ‰ä½œè€…ä¿¡æ¯,åˆ†ææ—¶å¯èƒ½éœ€è¦

**å»ºè®®**: æ·»åŠ  `author_id`, `author_name` å­—æ®µ

---

#### P1-2: ç¼ºå°‘æ•°æ®è´¨é‡ç›‘æ§

**é—®é¢˜**: æ— æ³•ç›‘æ§å»é‡ç‡ã€ç‰ˆæœ¬åˆ†å¸ƒã€TTL å‘½ä¸­ç‡

**å»ºè®®**: 
1. æ·»åŠ  `storage_metrics` è¡¨
2. è®°å½•æ¯æ—¥å»é‡ç‡ã€ç‰ˆæœ¬æ•°ã€è¿‡æœŸæ¸…ç†æ•°

---

#### P1-3: ç¼ºå°‘æ•°æ®å½’æ¡£æœºåˆ¶

**é—®é¢˜**: 90å¤©å¤–çš„æ•°æ®ç›´æ¥åˆ é™¤,æ— æ³•æ¢å¤

**å»ºè®®**:
1. æ·»åŠ  `posts_archive` è¡¨ (S3/Glacier)
2. å½’æ¡£åå†åˆ é™¤

---

#### P1-4: ç‰©åŒ–è§†å›¾åˆ·æ–°ç­–ç•¥ä¸æ˜ç¡®

**é—®é¢˜**: ä¸çŸ¥é“ä½•æ—¶åˆ·æ–°,åˆ·æ–°é¢‘ç‡å¤šå°‘

**å»ºè®®**:
1. å¢é‡åˆ·æ–°: æ¯æ¬¡ `_dual_write()` åè§¦å‘
2. å…¨é‡åˆ·æ–°: æ¯å¤©å‡Œæ™¨ 3 ç‚¹

---

#### P1-5: ç¼ºå°‘å­˜å‚¨å®¹é‡é¢„è­¦

**é—®é¢˜**: æ— æ³•æå‰é¢„è­¦å­˜å‚¨ç©ºé—´ä¸è¶³

**å»ºè®®**:
1. æ·»åŠ  `get_storage_stats()` å®šæ—¶ä»»åŠ¡
2. å½“å­˜å‚¨è¶…è¿‡ 80% æ—¶å‘é€å‘Šè­¦

---

## 4ï¸âƒ£ æ€»ç»“ä¸å»ºè®®

### 4.1 è®¾è®¡è¯„ä»·

**ä¼˜ç‚¹** âœ…:
1. å†·çƒ­åˆ†ç¦»æ¶æ„è®¾è®¡ä¼˜ç§€
2. SCD2 ç‰ˆæœ¬æ§åˆ¶æ€è·¯æ­£ç¡®
3. ç‰©åŒ–è§†å›¾ä¼˜åŒ–æ–¹å‘æ­£ç¡®
4. ç´¢å¼•è®¾è®¡å®Œæ•´

**ç¼ºç‚¹** âŒ:
1. è®¾è®¡ä¸å®æ–½è„±èŠ‚ (7ä¸ªP0é—®é¢˜)
2. ç»´æŠ¤ä»»åŠ¡ç¼ºå¤± (æ¸…ç†ã€åˆ·æ–°ã€å½’æ¡£)
3. åˆ†æå¼•æ“æœªé›†æˆå­˜å‚¨å±‚
4. è¿ç§»ç®¡ç†æ··ä¹± (SQL + Alembic)

### 4.2 ä¿®å¤ä¼˜å…ˆçº§

**ç¬¬ä¸€æ‰¹ (æœ¬å‘¨)** ğŸ”´:
1. P0-4: åˆ†æå¼•æ“é›†æˆå†·çƒ­å­˜å‚¨
2. P0-7: ç»Ÿä¸€è¿ç§»ç®¡ç† (Alembic)
3. P0-5: ä¿®å¤ SCD2 ç‰ˆæœ¬æ§åˆ¶

**ç¬¬äºŒæ‰¹ (ä¸‹å‘¨)** ğŸŸ¡:
4. P0-1: å®æ–½ç‰©åŒ–è§†å›¾åˆ·æ–°
5. P0-2: å®æ–½çƒ­ç¼“å­˜æ¸…ç†
6. P0-3: å®æ–½å†·åº“æ»šåŠ¨çª—å£

**ç¬¬ä¸‰æ‰¹ (é•¿æœŸ)** ğŸŸ¢:
7. P0-6: å‡çº§å“ˆå¸Œç®—æ³•
8. P1-1 ~ P1-5: ä¼˜åŒ–å»ºè®®

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-24  
**ä¸‹ä¸€æ­¥**: æ ¹æ®ä¼˜å…ˆçº§é€ä¸€ä¿®å¤é—®é¢˜

