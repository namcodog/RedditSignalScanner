# T1.6: 创建黑名单配置 - 验收报告

## 执行时间
- 开始时间: 2025-10-17
- 完成时间: 2025-10-17
- 执行人: Agent

## 任务目标
创建黑名单配置文件，添加黑名单社区和降权关键词，扩展 community_pool 表字段，实现黑名单加载逻辑，测试黑名单过滤功能。

## 执行过程

### 1. 创建黑名单配置文件
**文件**: `config/community_blacklist.yaml`

**配置内容**:
- **黑名单社区** (20个): 完全屏蔽，不抓取
  - Karma farming: FreeKarma4U, FreeKarma4You, Karma4Free
  - NSFW 内容: gonewild, NSFW, nsfw_gifs
  - 纯娱乐/低价值: memes, funny, AdviceAnimals, dankmemes
  - 政治/争议性: politics, The_Donald, Conservative, Liberal
  - 赌博/投机: wallstreetbets, Superstonk, amcstock, GME
  - 已封禁: The_Donald, ChapoTrapHouse

- **降权社区** (4个): 抓取但降低优先级
  - deadsubreddits: 低活跃度 (factor=0.5)
  - Entrepreneur: 过度商业化 (factor=0.7)
  - AskReddit: 噪音较多 (factor=0.6)
  - todayilearned: 低业务相关性 (factor=0.5)

- **降权关键词** (17个): 帖子包含这些词时降低评分
  - 抽奖/赠品: giveaway (-0.5), free stuff (-0.5), contest (-0.3)
  - 纯娱乐: for fun (-0.4), meme (-0.3)
  - 垃圾/spam: click here (-0.6), buy now (-0.5)
  - Karma farming: upvote if (-0.6)
  - 个人问题: help me (-0.2), what should i do (-0.2)

- **过滤关键词** (9个): 包含这些词的帖子直接过滤
  - 垃圾内容: viagra, cialis, porn, xxx
  - 诈骗指示词: get rich quick, make money fast
  - 仇恨言论: kill yourself, kys

- **白名单关键词** (8个): 即使在降权场景也保持/提升权重
  - looking for (+0.3), hiring (+0.5), seeking (+0.3)
  - need help with (+0.4), recommendation (+0.3)
  - alternative to (+0.4), frustrated with (+0.5)
  - better way to (+0.4)

### 2. 扩展数据库表结构
**模型修改**: `backend/app/models/community_pool.py`

新增字段:
```python
is_blacklisted: Mapped[bool]  # 是否在黑名单中
blacklist_reason: Mapped[str | None]  # 黑名单原因
downrank_factor: Mapped[float | None]  # 降权系数 (0.0-1.0)
```

**数据库迁移**: `backend/alembic/versions/20251017_000007_add_blacklist_fields_to_community_pool.py`
- 迁移状态: ✅ 成功执行
- 字段添加: is_blacklisted, blacklist_reason, downrank_factor

### 3. 实现黑名单加载逻辑
**服务模块**: `backend/app/services/blacklist_loader.py`

**核心功能**:
- `BlacklistConfig` 类: 加载并管理黑名单配置
- `is_community_blacklisted()`: 检查社区是否在黑名单中
- `is_community_downranked()`: 检查社区是否被降权
- `get_community_downrank_factor()`: 获取降权系数
- `should_filter_post()`: 检查帖子是否应被过滤
- `calculate_keyword_adjustment()`: 计算关键词调整分数
- `get_blacklist_config()`: 全局单例访问

**特性**:
- YAML 配置文件加载
- 单例模式（避免重复加载）
- 支持配置热重载 (`reload_blacklist_config()`)
- 详细日志记录

### 4. 创建数据库应用脚本
**脚本**: `scripts/apply_blacklist_to_db.py`

**功能**:
- 读取黑名单配置
- 更新 community_pool 表的黑名单字段
- 支持 dry-run 模式
- 自动清除过期的黑名单标记

### 5. 测试与验证
**Dry-run 测试**:
```bash
PYTHONPATH=backend python3 scripts/apply_blacklist_to_db.py --dry-run
```

**结果**:
- 黑名单社区: 1 个 (wallstreetbets)
- 降权社区: 1 个 (entrepreneur, factor=0.7)
- 未变更: 268 个

**实际应用**:
```bash
PYTHONPATH=backend python3 scripts/apply_blacklist_to_db.py
```

**结果**: ✅ 数据库更新成功

## 验收结果

### ✅ 配置文件完整
- 黑名单配置文件: `config/community_blacklist.yaml`
- 包含 5 类配置: 黑名单社区、降权社区、降权关键词、过滤关键词、白名单关键词
- 配置结构清晰，易于维护和扩展

### ✅ 数据库字段扩展
- community_pool 表新增 3 个字段
- 迁移文件已创建并成功执行
- 字段类型和约束正确

### ✅ 加载逻辑实现
- BlacklistConfig 类功能完整
- 支持社区级别和内容级别的过滤/降权
- 单例模式确保性能
- 日志记录完善

### ✅ 应用脚本可用
- 支持 dry-run 和实际应用两种模式
- 自动清除过期标记
- 统计信息清晰

### ✅ 测试通过
- Dry-run 测试成功
- 实际应用成功
- 数据库状态正确

## 黑名单应用效果

### 当前数据库状态
- 总社区数: 270 个
- 黑名单社区: 1 个 (wallstreetbets)
- 降权社区: 1 个 (entrepreneur)
- 正常社区: 268 个

### 预期效果
1. **抓取阶段**:
   - 黑名单社区 (is_blacklisted=true) 将被跳过，不抓取
   - 降权社区 (downrank_factor<1.0) 降低抓取频率

2. **分析阶段**:
   - 包含过滤关键词的帖子直接过滤
   - 包含降权关键词的帖子降低评分
   - 包含白名单关键词的帖子提升评分

3. **质量提升**:
   - 减少垃圾内容和低质量帖子
   - 提高机会信号的精准度
   - 降低噪音干扰

## 后续集成计划

### T1.7 分级调度集成
在分级调度中应用黑名单:
- 黑名单社区: 完全排除，不参与调度
- 降权社区: 降低调度频率（tier 降级或频率减半）

### 抓取任务集成
修改 `IncrementalCrawler` 和 `crawler_task.py`:
```python
from app.services.blacklist_loader import get_blacklist_config

config = get_blacklist_config()

# 过滤黑名单社区
if config.is_community_blacklisted(community_name):
    logger.info(f"跳过黑名单社区: {community_name}")
    return

# 应用降权系数
if config.is_community_downranked(community_name):
    downrank_factor = config.get_community_downrank_factor(community_name)
    # 调整抓取频率或优先级
```

### 分析引擎集成
修改评分器应用关键词调整:
```python
# 过滤帖子
if config.should_filter_post(post.title, post.content):
    continue

# 调整评分
adjustment = config.calculate_keyword_adjustment(post.title, post.content)
final_score = base_score + adjustment
```

## 配置维护建议

### 定期审查
- 每月审查黑名单社区列表
- 根据抓取效果调整降权系数
- 补充新发现的垃圾/低质量社区

### 关键词优化
- 根据误判情况调整降权关键词权重
- 补充新的过滤关键词（垃圾/诈骗）
- 优化白名单关键词（机会信号）

### 版本控制
- 配置文件纳入 Git 版本控制
- 重大变更记录到 `metadata.last_updated`
- 保留变更历史便于回滚

## 验收结论
✅ **T1.6 任务完成**

- 黑名单配置文件创建完成（5 类配置，50+ 条规则）
- 数据库表结构扩展完成（3 个新字段）
- 黑名单加载逻辑实现完成（BlacklistConfig 类）
- 数据库应用脚本创建并测试通过
- 当前已标记 1 个黑名单社区和 1 个降权社区

**下一步**: T1.7 分级调度策略实施，集成黑名单逻辑。

