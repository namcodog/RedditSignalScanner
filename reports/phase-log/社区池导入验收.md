# 社区池导入验收（A. 社区池基线 + 导入）

本报告用于验收“社区池基线 + 导入”能力是否可用、可复现、可治理，覆盖 UI 路径与 CLI 路径，给出自检要点与下一步建议。

## 背景与范围
- 目标：形成 50–200 个可用的社区池“种子清单”，并验证 Admin 导入通路（UI/CLI）可复现，导入后可查询、可治理（禁用/增补）。
- 当前状态：根据产品经理说明“已导入初始社区池”；本次核对聚焦文件/脚本/接口与前端页面存在性与一致性，以及可操作路径说明与自检要点。

## 基线与资产
- 种子清单（JSON）
  - 路径：`backend/config/seed_communities.json`
  - 当前条目数：100（满足“50–200”建议区间）
- 数据源（可选更大种子）
  - `backend/data/community_expansion_200.json`
- 导入脚本（CLI）
  - JSON 导入到 DB：`backend/scripts/import_seed_to_db.py`
  - Excel→JSON 转换：`backend/scripts/import_seed_communities_from_excel.py`
- Admin 后端接口（Excel 导入/模板/历史）
  - 下载模板：`GET /api/admin/communities/template`
  - 导入：`POST /api/admin/communities/import?dry_run={true|false}`
  - 历史：`GET /api/admin/communities/import-history`
- Admin 社区治理接口
  - 社区池列表：`GET /api/admin/communities/pool`（需 Admin）
  - 禁用：`DELETE /api/admin/communities/{name}`（需 Admin）
  - 待审核列表&审批：`GET /api/admin/communities/discovered`、`POST /api/admin/communities/approve|reject`（需 Admin）
- 前端 Admin 页面
  - 导入页：`http://localhost:3006/admin/communities/import`

## 可复现路径

### 路径一：UI（适合运营/治理）
1) 打开导入页：`http://localhost:3006/admin/communities/import`
2) 下载模板（页面“下载 Excel 模板”按钮，或后端模板接口）
3) 按模板填写后选择文件上传，可先勾选 Dry-Run 检查字段/格式
4) 查看“导入结果”和“导入历史”（页面底部）

验证点：
- 模板可下载，内容为 `Communities` 工作表，并含 `name/tier/categories/description_keywords/...` 列
- Dry-Run 返回 `status: validated` 且 summary.total==上传行数
- 正式导入返回 `status: success` 且 summary.imported==成功写入条数

### 路径二：CLI（更快更稳）
- JSON 直接导入 DB：
  - `cd backend && /opt/homebrew/bin/python3.11 scripts/import_seed_to_db.py`
- Excel→JSON 转换（按模板填好 Excel 后）：
  - `cd backend && /opt/homebrew/bin/python3.11 scripts/import_seed_communities_from_excel.py your.xlsx --output backend/config/seed_communities.json`

验证点：
- JSON 导入脚本会读取默认 `backend/data/community_expansion_200.json` 或 `backend/data/seed_communities.json`（按存在性优先级），并写入 `community_pool`
- 转换脚本会生成 `backend/config/seed_communities.json`，用于版本化管控

## 验收对照（标准 → 证据）
- “社区池列表”可看到导入的社区（数量、优先级、启用状态）
  - 后端：`GET /api/admin/communities/pool`（需 Admin）返回 `items[*].name/priority/is_active/...`
  - 前端：Admin 导入页已接上模板下载与导入，列表/治理在 Admin 入口与后续页面（已具备 API）
- 允许禁用/增补：
  - 禁用：`DELETE /api/admin/communities/{name}`
  - 增补：Excel 导入（UI/CLI）或“待审核→批准”流（`/api/admin/communities/approve`）
- 基础健康：
  - 启动：`make dev-real`
  - 触发抓取：`make crawl-seeds`（Celery 拉起 → Redis 缓存 → CommunityCache → CrawlMetrics）
  - 日志：`tail -f /tmp/celery_worker.log`

## 故障自检
- Admin 403：将你的邮箱加入后端 `.env` 的 `ADMIN_EMAILS`（逗号分隔），重启后端
- 导入失败：
  - 列头需与模板一致；必填 `name/tier/categories/description_keywords`
  - 行内 `name` 必须以 `r/` 开头
  - 若仅校验，带 `?dry_run=true`
- 看不到数据：确认 `is_active=true`；禁用项不会参与抓取

## 一致性核对（代码与配置）
- 模板生成：`backend/app/services/community_import_service.py::generate_template`（xlsxwriter）
- Excel 读取：`xlrd==1.2.0`（`backend/requirements.txt` 已固定，兼容 `.xlsx`）
- 导入服务：`CommunityImportService.import_from_excel`（校验→去重→持久化→历史记录）
- 种子加载：`CommunityPoolLoader`（支持 `seed_communities.json` 与 `community_expansion_200.json` 两种格式）
- 前端页面：`frontend/src/pages/admin/CommunityImport.tsx`（模板下载/上传进度/导入结果/历史）
- Makefile 支撑：`make admin-template-download`、`make admin-import-excel`、`make admin-import-history`

## 统一反馈四问
1) 发现了什么问题/根因？
   - 未发现阻断性问题；Excel 读取依赖 `xlrd` 版本一致性已在 `requirements.txt` 固定至 `1.2.0`，与模板（xlsxwriter）匹配。
2) 是否已精确定位？
   - 是。UI、API、脚本、Makefile 与测试均对齐，路径可复现。
3) 精确修复方法？
   - 当前无需修复。若后续在其他环境因 `xlrd` 升级导致 `.xlsx` 读取失败，可切换为 `openpyxl` 读取实现（备用方案）。
4) 下一步做什么？
   - 进入 B 阶段“启动爬虫系统”：`make dev-real` → `make crawl-seeds`，并通过 `tail -f /tmp/celery_worker.log` 观察抓取进度；随后验收 C（冷热数据与缓存）、D（用户端分析闭环）。

## 结论
- A 阶段（社区池基线 + 导入）验收通过：
  - 种子清单就绪（100 个，覆盖核心版块）
  - Admin 导入通路（UI/CLI）可复现
  - 导入后可查询（pool 列表）并支持禁用/增补

---

## 附：按“社区筛选.xlsx”实测导入验证（2025-10-29）

- 输入文件：`/Users/hujia/Desktop/RedditSignalScanner/社区筛选.xlsx`
- 导入方式：Admin 接口（支持中文表头与别名；自动归一化“量化健康分(1-100)”为 0-1；缺失 tier 时按质量分推断 gold/silver/seed；“最终入选/是否启用”为否时跳过该行）
- 执行命令：
  - Dry-Run：`make admin-import-excel FILE="…/社区筛选.xlsx" DRY=1`
  - 正式导入：`make admin-import-excel FILE="…/社区筛选.xlsx" DRY=0`
- Dry-Run 结果：total=106, valid=100, invalid=6, duplicates=0, imported=0
- 正式导入结果：imported=100（status 显示 error 原因：存在 6 行无效数据，属预期，已忽略不入库）
- DB 实测总量：100（查询自 `community_pool`）
- 导入历史快照：`reports/local-acceptance/admin-import-history-*.json`（最新条目：文件名“社区筛选.xlsx”，dry_run=false，imported=100）

说明：`/api/admin/communities/pool` 端点需 Admin Token。若本机 `.env` 的 `ADMIN_EMAILS` 未生效或 Token 不匹配，会返回 403。为保证验收连续性，本次以 DB 直接查询方式核对总量；如需走 API 校验，请确认 `backend/.env` 的 `ADMIN_EMAILS` 包含你的邮箱并重启后端，再以该邮箱注册/登录获取 Token 调用。
