# Celery å¹¶å‘æ§åˆ¶è¯„ä¼°æŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-27  
**è¯„ä¼°äºº**: AI Agent  
**ç›®çš„**: è¯„ä¼° Celery worker å¹¶å‘é…ç½®ä¸ Reddit API é€Ÿç‡é™åˆ¶çš„åŒ¹é…åº¦ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§

---

## 1. å½“å‰é…ç½®æ¦‚è§ˆ

### 1.1 Reddit API é€Ÿç‡é™åˆ¶

**å®˜æ–¹é™åˆ¶**: 60 requests/minute  
**å½“å‰é…ç½®**:

| é…ç½®é¡¹ | é»˜è®¤å€¼ | å®é™…ä½¿ç”¨ | ä½ç½® |
|--------|--------|----------|------|
| `REDDIT_RATE_LIMIT` | 60 | 60 | `backend/app/core/config.py:72` |
| `REDDIT_RATE_LIMIT_WINDOW_SECONDS` | 60.0 | 60.0 | `backend/app/core/config.py:73` |
| `REDDIT_MAX_CONCURRENCY` | 5 | 5 | `backend/app/core/config.py:75` |
| `REDDIT_REQUEST_TIMEOUT_SECONDS` | 30.0 | 30.0 | `backend/app/core/config.py:74` |

**ä¿å®ˆç­–ç•¥**:
- çˆ¬è™«ä»»åŠ¡: `rate_limit=min(58, settings.reddit_rate_limit)` (ç•™ 2 req/min ç¼“å†²)
- è¡¥å……æœç´¢: `rate_limit=min(30, settings.reddit_rate_limit)` (å‡åŠ)
- çƒŸé›¾æµ‹è¯•: `rate_limit=min(20, settings.reddit_rate_limit)` (æ›´ä¿å®ˆ)

---

### 1.2 Celery Worker å¹¶å‘é…ç½®

**å½“å‰é…ç½®**:

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è®¡ç®—é€»è¾‘ | ä½ç½® |
|--------|--------|----------|------|
| `worker_concurrency` | `min(cpu_cores, 4)` | åŠ¨æ€è®¡ç®— | `backend/app/core/celery_app.py:99` |
| `worker_prefetch_multiplier` | 1 | å›ºå®š | `backend/app/core/celery_app.py:100` |
| `worker_pool` | `solo` (macOS) | å¯åŠ¨è„šæœ¬æŒ‡å®š | `backend/start_celery_worker.sh:15` |

**é˜Ÿåˆ—é…ç½®**:
- `analysis_queue` - åˆ†æä»»åŠ¡ï¼ˆä¸»è¦æ¶ˆè€— Reddit APIï¼‰
- `crawler_queue` - çˆ¬è™«ä»»åŠ¡ï¼ˆä¸»è¦æ¶ˆè€— Reddit APIï¼‰
- `monitoring_queue` - ç›‘æ§ä»»åŠ¡ï¼ˆè½»é‡çº§ï¼‰
- `maintenance_queue` - ç»´æŠ¤ä»»åŠ¡ï¼ˆè½»é‡çº§ï¼‰
- `cleanup_queue` - æ¸…ç†ä»»åŠ¡ï¼ˆè½»é‡çº§ï¼‰

---

## 2. å¹¶å‘å†²çªé£é™©åˆ†æ

### 2.1 ç†è®ºæœ€å¤§å¹¶å‘

**åœºæ™¯ 1: å• Workerï¼Œ4 å¹¶å‘**
- Worker å¹¶å‘æ•°: 4
- æ¯ä¸ªä»»åŠ¡çš„ Reddit å¹¶å‘: 5 (`REDDIT_MAX_CONCURRENCY`)
- **ç†è®ºæœ€å¤§å¹¶å‘**: 4 Ã— 5 = **20 concurrent requests**

**åœºæ™¯ 2: å¤š Workerï¼ˆå¦‚ 2 ä¸ª Workerï¼‰**
- Worker æ•°é‡: 2
- æ¯ä¸ª Worker å¹¶å‘: 4
- æ¯ä¸ªä»»åŠ¡çš„ Reddit å¹¶å‘: 5
- **ç†è®ºæœ€å¤§å¹¶å‘**: 2 Ã— 4 Ã— 5 = **40 concurrent requests**

### 2.2 é€Ÿç‡é™åˆ¶å†²çª

**Reddit API é™åˆ¶**: 60 requests/minute  
**å½“å‰ä¿æŠ¤æœºåˆ¶**:

1. âœ… **RedditAPIClient å†…ç½®é€Ÿç‡é™åˆ¶**
   - ä½¿ç”¨ `asyncio.Semaphore` æ§åˆ¶å¹¶å‘
   - ä½¿ç”¨ `deque` è®°å½•è¯·æ±‚æ—¶é—´ï¼Œæ»‘åŠ¨çª—å£é™æµ
   - ä½ç½®: `backend/app/services/reddit_client.py:76-78`

2. âœ… **ä»»åŠ¡çº§åˆ«é€Ÿç‡é™åˆ¶**
   - ä¸åŒåœºæ™¯ä½¿ç”¨ä¸åŒçš„ `rate_limit` å‚æ•°
   - çˆ¬è™«: 58 req/min
   - åˆ†æ: 60 req/min
   - è¡¥å……æœç´¢: 30 req/min

3. âš ï¸ **è·¨ Worker åè°ƒç¼ºå¤±**
   - æ¯ä¸ª Worker ç‹¬ç«‹è®¡ç®—é€Ÿç‡é™åˆ¶
   - å¤š Worker åœºæ™¯ä¸‹å¯èƒ½è¶…é™

---

## 3. å®é™…é£é™©è¯„ä¼°

### 3.1 ä½é£é™©åœºæ™¯ âœ…

**æ¡ä»¶**:
- å• Worker è¿è¡Œ
- `worker_concurrency <= 4`
- `REDDIT_MAX_CONCURRENCY = 5`

**åˆ†æ**:
- æœ€å¤§å¹¶å‘: 4 Ã— 5 = 20 requests
- é€Ÿç‡é™åˆ¶: 60 req/min
- **å®‰å…¨ä½™é‡**: 40 req/min (67%)

**ç»“è®º**: âœ… **å½“å‰é…ç½®å®‰å…¨**

---

### 3.2 ä¸­é£é™©åœºæ™¯ âš ï¸

**æ¡ä»¶**:
- 2 ä¸ª Worker åŒæ—¶è¿è¡Œ
- æ¯ä¸ª Worker å¹¶å‘ 4
- åŒæ—¶å¤„ç†å¤šä¸ªåˆ†æä»»åŠ¡

**åˆ†æ**:
- æœ€å¤§å¹¶å‘: 2 Ã— 4 Ã— 5 = 40 requests
- é€Ÿç‡é™åˆ¶: 60 req/min
- **å®‰å…¨ä½™é‡**: 20 req/min (33%)

**æ½œåœ¨é—®é¢˜**:
- å¦‚æœä¸¤ä¸ª Worker åŒæ—¶å¯åŠ¨å¤šä¸ªä»»åŠ¡ï¼Œå¯èƒ½çŸ­æ—¶é—´å†…è¶…é™
- RedditAPIClient çš„é€Ÿç‡é™åˆ¶æ˜¯è¿›ç¨‹å†…çš„ï¼Œæ— æ³•è·¨ Worker åè°ƒ

**å»ºè®®**:
- ç›‘æ§ Reddit API 429 é”™è¯¯
- è€ƒè™‘ä½¿ç”¨ Redis å®ç°è·¨ Worker çš„å…¨å±€é€Ÿç‡é™åˆ¶

---

### 3.3 é«˜é£é™©åœºæ™¯ âŒ

**æ¡ä»¶**:
- 3+ ä¸ª Worker åŒæ—¶è¿è¡Œ
- é«˜å¹¶å‘åˆ†æä»»åŠ¡

**åˆ†æ**:
- æœ€å¤§å¹¶å‘: 3 Ã— 4 Ã— 5 = 60 requests
- **å·²è¾¾åˆ° Reddit API ä¸Šé™**

**ç»“è®º**: âŒ **ä¸æ¨è**

---

## 4. æ”¹è¿›å»ºè®®

### 4.1 çŸ­æœŸæ”¹è¿›ï¼ˆP2 - æœ¬å‘¨å†…ï¼‰

#### âœ… å»ºè®® 1: é™ä½ `REDDIT_MAX_CONCURRENCY`

**å½“å‰**: 5  
**å»ºè®®**: 3

**ç†ç”±**:
- é™ä½å•ä»»åŠ¡å¹¶å‘ï¼Œå‡å°‘å³°å€¼å‹åŠ›
- å³ä½¿ 2 ä¸ª Workerï¼Œæœ€å¤§å¹¶å‘ä¹Ÿåªæœ‰ 2 Ã— 4 Ã— 3 = 24 requests
- å®‰å…¨ä½™é‡æå‡åˆ° 60%

**ä¿®æ”¹ä½ç½®**:
```python
# backend/app/core/config.py:75
reddit_max_concurrency: int = Field(default=3)  # ä» 5 é™åˆ° 3
```

---

#### âœ… å»ºè®® 2: æ·»åŠ å…¨å±€é€Ÿç‡é™åˆ¶ç›‘æ§

**å®ç°æ–¹å¼**:
- åœ¨ `RedditAPIClient` ä¸­æ·»åŠ  Redis è®¡æ•°å™¨
- è®°å½•å…¨å±€ API è°ƒç”¨æ¬¡æ•°
- è¶…è¿‡é˜ˆå€¼æ—¶ä¸»åŠ¨é™é€Ÿ

**ç¤ºä¾‹ä»£ç **:
```python
# backend/app/services/reddit_client.py

async def _check_global_rate_limit(self) -> bool:
    """æ£€æŸ¥å…¨å±€é€Ÿç‡é™åˆ¶ï¼ˆè·¨ Workerï¼‰"""
    redis_key = "reddit_api:global_rate_limit"
    current_count = await redis.incr(redis_key)
    
    if current_count == 1:
        await redis.expire(redis_key, 60)  # 60 ç§’çª—å£
    
    if current_count > 55:  # ç•™ 5 req/min ç¼“å†²
        logger.warning(f"Global rate limit approaching: {current_count}/60")
        return False
    
    return True
```

---

#### âœ… å»ºè®® 3: é™åˆ¶ Celery Worker æ•°é‡

**å½“å‰**: åŠ¨æ€è®¡ç®— `min(cpu_cores, 4)`  
**å»ºè®®**: æ˜ç¡®é™åˆ¶ä¸º 1-2 ä¸ª Worker

**ä¿®æ”¹ä½ç½®**:
```bash
# backend/start_celery_worker.sh
# æˆ–ç¯å¢ƒå˜é‡
export CELERY_WORKER_COUNT=1  # å¼ºåˆ¶å• Worker
```

**ç†ç”±**:
- å• Worker è¶³å¤Ÿå¤„ç†å½“å‰è´Ÿè½½
- é¿å…è·¨ Worker é€Ÿç‡é™åˆ¶å†²çª
- ç®€åŒ–ç›‘æ§å’Œè°ƒè¯•

---

### 4.2 é•¿æœŸæ”¹è¿›ï¼ˆP3 - æŒ‰éœ€ï¼‰

#### ğŸ”µ å»ºè®® 4: å®ç°åˆ†å¸ƒå¼é€Ÿç‡é™åˆ¶

**æ–¹æ¡ˆ**: ä½¿ç”¨ Redis + Lua è„šæœ¬å®ç°ä»¤ç‰Œæ¡¶ç®—æ³•

**ä¼˜ç‚¹**:
- è·¨ Worker ç²¾ç¡®æ§åˆ¶
- æ”¯æŒåŠ¨æ€è°ƒæ•´é€Ÿç‡
- å¯è§†åŒ–ç›‘æ§

**å‚è€ƒå®ç°**: `aioredis-rate-limit` æˆ–è‡ªå®šä¹‰ Lua è„šæœ¬

---

#### ğŸ”µ å»ºè®® 5: ä»»åŠ¡ä¼˜å…ˆçº§é˜Ÿåˆ—

**å½“å‰**: æ‰€æœ‰åˆ†æä»»åŠ¡å¹³ç­‰
**å»ºè®®**: åŒºåˆ†é«˜ä¼˜å…ˆçº§ï¼ˆä»˜è´¹ç”¨æˆ·ï¼‰å’Œä½ä¼˜å…ˆçº§ï¼ˆå…è´¹ç”¨æˆ·ï¼‰

**å®ç°**:
- ä½¿ç”¨ Celery çš„ `priority` å‚æ•°
- é«˜ä¼˜å…ˆçº§ä»»åŠ¡ä¼˜å…ˆè·å– Reddit API é…é¢

---

## 5. ç›‘æ§æŒ‡æ ‡

### 5.1 éœ€è¦ç›‘æ§çš„æŒ‡æ ‡

| æŒ‡æ ‡ | é˜ˆå€¼ | å‘Šè­¦çº§åˆ« |
|------|------|----------|
| Reddit API 429 é”™è¯¯ç‡ | > 1% | âš ï¸ Warning |
| å…¨å±€ API è°ƒç”¨é€Ÿç‡ | > 55 req/min | âš ï¸ Warning |
| Celery Worker å¹¶å‘æ•° | > 2 | â„¹ï¸ Info |
| ä»»åŠ¡é˜Ÿåˆ—ç§¯å‹ | > 10 | âš ï¸ Warning |
| å¹³å‡ä»»åŠ¡ç­‰å¾…æ—¶é—´ | > 5 min | âš ï¸ Warning |

### 5.2 ç›‘æ§å®ç°

**å·²æœ‰ç›‘æ§**:
- âœ… `monitor_api_calls` - ç›‘æ§ API è°ƒç”¨æ¬¡æ•°
- âœ… `monitor_cache_health` - ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡

**å»ºè®®æ–°å¢**:
- ğŸ”µ `monitor_reddit_rate_limit` - ç›‘æ§ Reddit API é€Ÿç‡é™åˆ¶
- ğŸ”µ `monitor_celery_concurrency` - ç›‘æ§ Worker å¹¶å‘æ•°

---

## 6. ç»“è®ºä¸è¡ŒåŠ¨è®¡åˆ’

### 6.1 å½“å‰çŠ¶æ€è¯„ä¼°

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| å• Worker å®‰å…¨æ€§ | âœ… ä¼˜ç§€ | å®‰å…¨ä½™é‡ 67% |
| å¤š Worker å®‰å…¨æ€§ | âš ï¸ ä¸­ç­‰ | å­˜åœ¨è¶…é™é£é™© |
| ç›‘æ§å®Œæ•´æ€§ | âš ï¸ ä¸­ç­‰ | ç¼ºå°‘å…¨å±€é€Ÿç‡ç›‘æ§ |
| æ‰©å±•æ€§ | âš ï¸ ä¸­ç­‰ | éš¾ä»¥æ°´å¹³æ‰©å±• |

**æ€»ä½“è¯„åˆ†**: **B çº§ï¼ˆè‰¯å¥½ï¼‰**

---

### 6.2 è¡ŒåŠ¨è®¡åˆ’

#### **ç«‹å³æ‰§è¡Œï¼ˆæœ¬å‘¨å†…ï¼‰**

1. âœ… **é™ä½ `REDDIT_MAX_CONCURRENCY` ä» 5 åˆ° 3**
   - ä¿®æ”¹ `backend/app/core/config.py`
   - é‡å¯ Celery Worker

2. âœ… **é™åˆ¶ Worker æ•°é‡ä¸º 1**
   - è®¾ç½®ç¯å¢ƒå˜é‡ `CELERY_WORKER_COUNT=1`
   - æ›´æ–°å¯åŠ¨è„šæœ¬

3. âœ… **æ·»åŠ  Reddit API 429 é”™è¯¯ç›‘æ§**
   - åœ¨ `RedditAPIClient` ä¸­è®°å½• 429 é”™è¯¯
   - å‘é€å‘Šè­¦åˆ°æ—¥å¿—

#### **çŸ­æœŸæ‰§è¡Œï¼ˆ2 å‘¨å†…ï¼‰**

4. ğŸ”µ **å®ç°å…¨å±€é€Ÿç‡é™åˆ¶ç›‘æ§**
   - ä½¿ç”¨ Redis è®¡æ•°å™¨
   - æ¥è¿‘é˜ˆå€¼æ—¶ä¸»åŠ¨é™é€Ÿ

5. ğŸ”µ **ä¼˜åŒ–ä»»åŠ¡è°ƒåº¦ç­–ç•¥**
   - è¯„ä¼°æ˜¯å¦éœ€è¦ä¼˜å…ˆçº§é˜Ÿåˆ—
   - è€ƒè™‘ä»»åŠ¡å»é‡

#### **é•¿æœŸè§„åˆ’ï¼ˆæŒ‰éœ€ï¼‰**

6. ğŸ”µ **åˆ†å¸ƒå¼é€Ÿç‡é™åˆ¶**
   - ä½¿ç”¨ Redis + Lua è„šæœ¬
   - æ”¯æŒå¤š Worker åœºæ™¯

7. ğŸ”µ **æ°´å¹³æ‰©å±•æ–¹æ¡ˆ**
   - è®¾è®¡å¤š Worker åè°ƒæœºåˆ¶
   - å®ç°åŠ¨æ€æ‰©ç¼©å®¹

---

## 7. é™„å½•

### 7.1 ç›¸å…³æ–‡ä»¶

- `backend/app/core/config.py` - é…ç½®æ–‡ä»¶
- `backend/app/core/celery_app.py` - Celery é…ç½®
- `backend/app/services/reddit_client.py` - Reddit API å®¢æˆ·ç«¯
- `backend/start_celery_worker.sh` - Worker å¯åŠ¨è„šæœ¬

### 7.2 å‚è€ƒæ–‡æ¡£

- Reddit API å®˜æ–¹æ–‡æ¡£: https://www.reddit.com/dev/api
- Celery å¹¶å‘æ§åˆ¶: https://docs.celeryq.dev/en/stable/userguide/workers.html
- åˆ†å¸ƒå¼é€Ÿç‡é™åˆ¶: https://redis.io/docs/manual/patterns/rate-limiter/

