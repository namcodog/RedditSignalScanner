# å†·çƒ­åˆ†å±‚å­˜å‚¨æ¶æ„å®æ–½æŠ¥å‘Š

ç”Ÿæˆæ—¶é—´ï¼š2025-10-16 20:20  
çŠ¶æ€ï¼šâœ… æ•°æ®åº“è¿ç§»å®Œæˆï¼Œå¾…å®æ–½æŠ“å–å™¨å’Œåˆ†æå¼•æ“æ”¹é€ 

---

## ğŸ“‹ å®æ–½æ¦‚è¿°

æŒ‰ç…§ç”¨æˆ·æå‡ºçš„"å†·çƒ­åˆ†å±‚ï¼šå¢é‡ç´¯ç§¯ + å®æ—¶çƒ­ç¼“å­˜"æ¶æ„ï¼Œå·²å®Œæˆæ•°æ®åº“å±‚é¢çš„æ”¹é€ ã€‚

**æ ¸å¿ƒåŸåˆ™ï¼šçƒ­åˆ·ä¸ä¸¢ï¼Œå†·åº“å¿…å­˜**
- **çƒ­ç¼“å­˜ï¼ˆHot Cacheï¼‰**ï¼šæœ€è¿‘ 24-72 å°æ—¶ï¼Œç”¨äºå®æ—¶åˆ†æ
- **å†·å­˜å‚¨ï¼ˆCold Storeï¼‰**ï¼šå¢é‡ç´¯ç§¯ï¼Œ90 å¤©æ»šåŠ¨çª—å£ï¼Œç”¨äºç®—æ³•è®­ç»ƒå’Œè¶‹åŠ¿åˆ†æ

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“æ¶æ„

**æ–°å¢è¡¨ï¼š**

| è¡¨å | ç±»å‹ | ç”¨é€” | æ•°æ®é‡ |
|------|------|------|--------|
| `posts_raw` | å†·åº“ | å¢é‡ç´¯ç§¯ï¼Œä¿ç•™90å¤© | é¢„è®¡ 300K-800K æ¡ |
| `posts_hot` | çƒ­ç¼“å­˜ | è¦†ç›–å¼åˆ·æ–°ï¼Œ24-72å°æ—¶ | ~15K æ¡ |
| `posts_latest` | ç‰©åŒ–è§†å›¾ | åªä¿ç•™æœ€æ–°ç‰ˆæœ¬ | ~100K æ¡ |

**æ‰©å±•è¡¨ï¼š**
- `community_cache`ï¼šæ·»åŠ æ°´ä½çº¿å­—æ®µï¼ˆ`last_seen_post_id`, `last_seen_created_at`ï¼‰

---

### 2. æ ¸å¿ƒåŠŸèƒ½

#### æ–‡æœ¬å½’ä¸€åŒ–ä¸å»é‡

**å‡½æ•°ï¼š`text_norm_hash(content TEXT)`**
```sql
-- å½’ä¸€åŒ–æ­¥éª¤ï¼š
-- 1. è½¬å°å†™
-- 2. å»é™¤æ ‡ç‚¹ç¬¦å·
-- 3. å»é™¤å¤šä½™ç©ºæ ¼
-- 4. è¿”å› MD5 å“ˆå¸Œçš„ UUID

SELECT text_norm_hash('Hello, World!');
-- è¿”å›: 6cd3556deb0da54bca060b4c39479839
```

**å»é‡ç­–ç•¥ï¼šå¤šé”®ç»„åˆ**
- `source` + `source_post_id`ï¼šå¹³å°å†…å”¯ä¸€
- `text_norm_hash`ï¼šé˜²æ­¢è½¬è´´/æ”¹å†™

---

#### SCD2 ç‰ˆæœ¬è¿½è¸ª

**å­—æ®µï¼š**
- `version`ï¼šç‰ˆæœ¬å·ï¼Œæ¯æ¬¡ç¼–è¾‘ +1
- `valid_from` / `valid_to`ï¼šç‰ˆæœ¬ç”Ÿæ•ˆ/å¤±æ•ˆæ—¶é—´
- `is_current`ï¼šæ˜¯å¦å½“å‰ç‰ˆæœ¬

**ç¤ºä¾‹ï¼š**
```sql
-- å¸–å­è¢«ç¼–è¾‘æ—¶ï¼Œæ—§ç‰ˆæœ¬ï¼š
UPDATE posts_raw 
SET is_current = FALSE, 
    valid_to = NOW()
WHERE source_post_id = 'abc123' AND is_current = TRUE;

-- æ’å…¥æ–°ç‰ˆæœ¬ï¼š
INSERT INTO posts_raw (source_post_id, version, ...)
VALUES ('abc123', 2, ...);
```

---

#### æ°´ä½çº¿æœºåˆ¶

**å­—æ®µï¼ˆcommunity_cacheï¼‰ï¼š**
- `last_seen_post_id`ï¼šæœ€åæŠ“å–çš„å¸–å­ ID
- `last_seen_created_at`ï¼šæœ€åæŠ“å–çš„å¸–å­åˆ›å»ºæ—¶é—´
- `total_posts_fetched`ï¼šç´¯è®¡æŠ“å–æ•°
- `dedup_rate`ï¼šå»é‡ç‡ï¼ˆ%ï¼‰

**ç”¨é€”ï¼š**
- å¢é‡æŠ“å–ï¼šåªæ‹‰å–æ–°äºæ°´ä½çº¿çš„å¸–å­
- é¿å…é‡å¤æŠ“å–
- ç»Ÿè®¡æŠ“å–æ•ˆç‡

---

### 3. è¾…åŠ©åŠŸèƒ½

**è‡ªåŠ¨å¡«å……å½’ä¸€åŒ–å­—æ®µï¼š**
```sql
CREATE TRIGGER trg_fill_normalized_fields
BEFORE INSERT OR UPDATE ON posts_raw
FOR EACH ROW
EXECUTE FUNCTION fill_normalized_fields();
```

**åˆ·æ–°ç‰©åŒ–è§†å›¾ï¼š**
```sql
SELECT refresh_posts_latest();  -- è¿”å›åˆ·æ–°çš„è¡Œæ•°
```

**æ¸…ç†è¿‡æœŸçƒ­ç¼“å­˜ï¼š**
```sql
SELECT cleanup_expired_hot_cache();  -- è¿”å›åˆ é™¤çš„è¡Œæ•°
```

**æ¸…ç†æ—§æ•°æ®ï¼ˆ90å¤©æ»šåŠ¨çª—å£ï¼‰ï¼š**
```sql
SELECT cleanup_old_posts(90);  -- åˆ é™¤è¶…è¿‡90å¤©çš„éå½“å‰ç‰ˆæœ¬
```

**è·å–å­˜å‚¨ç»Ÿè®¡ï¼š**
```sql
SELECT * FROM get_storage_stats();
```

---

## ğŸ“Š æ•°æ®æ¨¡å‹è¯¦è§£

### posts_rawï¼ˆå†·åº“ï¼‰

```sql
CREATE TABLE posts_raw (
    -- ä¸»é”®
    source VARCHAR(50),
    source_post_id VARCHAR(100),
    version INTEGER,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP WITH TIME ZONE,
    fetched_at TIMESTAMP WITH TIME ZONE,
    valid_from TIMESTAMP WITH TIME ZONE,
    valid_to TIMESTAMP WITH TIME ZONE,
    is_current BOOLEAN,
    
    -- ä½œè€…
    author_id VARCHAR(100),
    author_name VARCHAR(100),
    
    -- å†…å®¹
    title TEXT,
    body TEXT,
    body_norm TEXT,  -- è‡ªåŠ¨å¡«å……
    text_norm_hash UUID,  -- è‡ªåŠ¨å¡«å……
    
    -- å…ƒæ•°æ®
    url TEXT,
    subreddit VARCHAR(100),
    score INTEGER,
    num_comments INTEGER,
    is_deleted BOOLEAN,
    edit_count INTEGER,
    lang VARCHAR(10),
    metadata JSONB,
    
    PRIMARY KEY (source, source_post_id, version)
);
```

**ç´¢å¼•ï¼š**
- æ—¶é—´èŒƒå›´æŸ¥è¯¢ï¼š`created_at DESC`, `fetched_at DESC`
- ç¤¾åŒºæŸ¥è¯¢ï¼š`(subreddit, created_at DESC)`
- å»é‡æŸ¥è¯¢ï¼š`text_norm_hash`, `(source, source_post_id)`
- SCD2 æŸ¥è¯¢ï¼š`(source, source_post_id, is_current) WHERE is_current = TRUE`
- å…ƒæ•°æ®æŸ¥è¯¢ï¼š`GIN (metadata)`

---

### posts_hotï¼ˆçƒ­ç¼“å­˜ï¼‰

```sql
CREATE TABLE posts_hot (
    source VARCHAR(50),
    source_post_id VARCHAR(100),
    created_at TIMESTAMP WITH TIME ZONE,
    cached_at TIMESTAMP WITH TIME ZONE,
    expires_at TIMESTAMP WITH TIME ZONE,  -- TTL: 24-72 å°æ—¶
    
    title TEXT,
    body TEXT,
    subreddit VARCHAR(100),
    score INTEGER,
    num_comments INTEGER,
    metadata JSONB,
    
    PRIMARY KEY (source, source_post_id)
);
```

**ç´¢å¼•ï¼š**
- TTL æ¸…ç†ï¼š`expires_at`
- ç¤¾åŒºæŸ¥è¯¢ï¼š`(subreddit, created_at DESC)`
- æ—¶é—´æŸ¥è¯¢ï¼š`created_at DESC`

---

### posts_latestï¼ˆç‰©åŒ–è§†å›¾ï¼‰

```sql
CREATE MATERIALIZED VIEW posts_latest AS
SELECT * FROM posts_raw WHERE is_current = TRUE;
```

**ç”¨é€”ï¼š**
- å¿«é€ŸæŸ¥è¯¢æœ€æ–°ç‰ˆæœ¬
- é¿å…æ‰«ææ‰€æœ‰å†å²ç‰ˆæœ¬
- å®šæœŸåˆ·æ–°ï¼ˆå»ºè®®æ¯å°æ—¶ï¼‰

---

## ğŸ¯ ç®—æ³•æ”¶ç›Š

### 1. è¶‹åŠ¿åˆ†æ

**7/14/30 å¤©çª—å£ï¼š**
```sql
-- è¿‡å» 30 å¤©çš„ä¸»é¢˜è¶‹åŠ¿
SELECT 
    DATE_TRUNC('day', created_at) AS day,
    subreddit,
    COUNT(*) AS post_count,
    AVG(score) AS avg_score
FROM posts_raw
WHERE created_at > NOW() - INTERVAL '30 days'
  AND is_current = TRUE
GROUP BY day, subreddit
ORDER BY day DESC, post_count DESC;
```

---

### 2. å»é‡ä¸è¯æ®è®¡æ•°

**è¿‡å» 72 å°æ—¶åŒä¸»é¢˜å¸–å­ï¼š**
```sql
-- æ‰¾å‡ºç›¸ä¼¼å†…å®¹çš„å¸–å­ï¼ˆè¯æ®é“¾ï¼‰
SELECT 
    text_norm_hash,
    COUNT(*) AS duplicate_count,
    ARRAY_AGG(source_post_id) AS post_ids,
    MIN(created_at) AS first_seen,
    MAX(created_at) AS last_seen
FROM posts_raw
WHERE created_at > NOW() - INTERVAL '72 hours'
  AND is_current = TRUE
GROUP BY text_norm_hash
HAVING COUNT(*) > 1
ORDER BY duplicate_count DESC;
```

---

### 3. å›æµ‹ä¸è¯„ä¼°

**å†å²æ ·æœ¬é‡æ”¾ï¼š**
```sql
-- è·å–æŸä¸ªæ—¶é—´ç‚¹çš„æ•°æ®å¿«ç…§
SELECT *
FROM posts_raw
WHERE valid_from <= '2025-10-01'::TIMESTAMP
  AND valid_to > '2025-10-01'::TIMESTAMP;
```

---

### 4. å¼‚å¸¸æ¢æµ‹

**ç¤¾åŒºå™ªå£°å‘¨æœŸï¼š**
```sql
-- æ£€æµ‹å¼‚å¸¸æ´»è·ƒçš„æ—¶æ®µ
SELECT 
    subreddit,
    DATE_TRUNC('hour', created_at) AS hour,
    COUNT(*) AS post_count,
    AVG(COUNT(*)) OVER (PARTITION BY subreddit) AS avg_count
FROM posts_raw
WHERE created_at > NOW() - INTERVAL '7 days'
GROUP BY subreddit, hour
HAVING COUNT(*) > AVG(COUNT(*)) OVER (PARTITION BY subreddit) * 2
ORDER BY post_count DESC;
```

---

## ğŸ“ˆ å­˜å‚¨ç©ºé—´ä¼°ç®—

### å•æ¡å¸–å­å¤§å°

```
å¹³å‡å¤§å°ï¼š~2 KB/æ¡
- title: ~100 bytes
- body: ~1500 bytes
- metadata: ~400 bytes
```

### å®¹é‡è§„åˆ’

| æ—¶é—´çª—å£ | å¸–å­æ•° | å­˜å‚¨ç©ºé—´ | è¯´æ˜ |
|---------|--------|----------|------|
| 24 å°æ—¶ | ~15K | ~30 MB | çƒ­ç¼“å­˜ |
| 7 å¤© | ~100K | ~200 MB | å†·åº“ï¼ˆå½“å‰ç‰ˆæœ¬ï¼‰ |
| 30 å¤© | ~300K | ~600 MB | å†·åº“ï¼ˆå½“å‰ç‰ˆæœ¬ï¼‰ |
| 90 å¤© | ~800K | ~1.6 GB | å†·åº“ï¼ˆå«å†å²ç‰ˆæœ¬ï¼‰ |

**ç»“è®ºï¼šå®Œå…¨å¯æ¥å—ï¼**

---

## ğŸš€ ä¸‹ä¸€æ­¥å·¥ä½œ

### 1. ä¿®æ”¹æŠ“å–å™¨ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

**æ–‡ä»¶ï¼š`backend/app/tasks/crawler_task.py`**

**æ”¹é€ ç‚¹ï¼š**
1. å¢é‡æŠ“å–ï¼šä½¿ç”¨æ°´ä½çº¿
2. Upsert é€»è¾‘ï¼š`ON CONFLICT DO UPDATE`
3. åŒæ—¶å†™å…¥å†·åº“å’Œçƒ­ç¼“å­˜
4. æ›´æ–°æ°´ä½çº¿å’Œç»Ÿè®¡

**ä¼ªä»£ç ï¼š**
```python
async def crawl_with_watermark(subreddit):
    # 1. è·å–æ°´ä½çº¿
    watermark = await get_watermark(subreddit)
    
    # 2. å¢é‡æŠ“å–ï¼ˆåªæ‹‰å–æ–°å¸–å­ï¼‰
    posts = await reddit.fetch_posts(
        subreddit,
        after=watermark.last_seen_created_at
    )
    
    # 3. Upsert åˆ°å†·åº“
    for post in posts:
        await upsert_to_cold_storage(post)
    
    # 4. è¦†ç›–å†™å…¥çƒ­ç¼“å­˜
    await refresh_hot_cache(subreddit, posts)
    
    # 5. æ›´æ–°æ°´ä½çº¿
    await update_watermark(subreddit, posts[-1])
```

---

### 2. ä¿®æ”¹åˆ†æå¼•æ“ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

**æ–‡ä»¶ï¼š`backend/app/services/analysis_engine.py`**

**æ”¹é€ ç‚¹ï¼š**
1. ä¼˜å…ˆè¯»å–çƒ­ç¼“å­˜
2. è¡¥è¯»å†·åº“ï¼ˆæœ€è¿‘ 30 å¤©ï¼‰
3. æ”¯æŒæ—¶é—´çª—å£æŸ¥è¯¢

**ä¼ªä»£ç ï¼š**
```python
async def collect_posts(subreddits, window_days=30):
    # 1. ä¼˜å…ˆä»çƒ­ç¼“å­˜è¯»å–
    hot_posts = await read_from_hot_cache(subreddits)
    
    # 2. è¡¥è¯»å†·åº“ï¼ˆæœ€è¿‘ N å¤©ï¼‰
    cutoff = NOW() - timedelta(days=window_days)
    cold_posts = await read_from_cold_storage(
        subreddits,
        created_after=cutoff
    )
    
    # 3. åˆå¹¶å»é‡
    all_posts = deduplicate(hot_posts + cold_posts)
    
    return all_posts
```

---

### 3. æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

**ä»»åŠ¡ï¼š**
1. æ¯å°æ—¶åˆ·æ–°ç‰©åŒ–è§†å›¾
2. æ¯å¤©æ¸…ç†è¿‡æœŸçƒ­ç¼“å­˜
3. æ¯å‘¨æ¸…ç†æ—§æ•°æ®ï¼ˆ90å¤©çª—å£ï¼‰

**Celery Beat é…ç½®ï¼š**
```python
celery_app.conf.beat_schedule = {
    "refresh-posts-latest": {
        "task": "tasks.maintenance.refresh_posts_latest",
        "schedule": crontab(minute="0", hour="*"),  # æ¯å°æ—¶
    },
    "cleanup-hot-cache": {
        "task": "tasks.maintenance.cleanup_hot_cache",
        "schedule": crontab(minute="0", hour="0"),  # æ¯å¤©
    },
    "cleanup-old-posts": {
        "task": "tasks.maintenance.cleanup_old_posts",
        "schedule": crontab(minute="0", hour="0", day_of_week="0"),  # æ¯å‘¨
    },
}
```

---

### 4. æ·»åŠ ç›‘æ§ä»ªè¡¨ç›˜ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

**æŒ‡æ ‡ï¼š**
- æ–°å¢æŠ“å–é‡/å°æ—¶
- ç´¯è®¡æ ·æœ¬/å¤©
- å»é‡ç‡
- ç¼–è¾‘æ›´æ–°ç‡
- åˆ é™¤/å¤±æ•ˆç‡
- å­˜å‚¨ç©ºé—´ä½¿ç”¨ç‡

---

## ğŸ“ éªŒè¯æ¸…å•

- [x] æ•°æ®åº“è¿ç§»å®Œæˆ
- [x] æ–‡æœ¬å½’ä¸€åŒ–å‡½æ•°
- [x] å»é‡ç­–ç•¥ï¼ˆå¤šé”®ç»„åˆï¼‰
- [x] SCD2 ç‰ˆæœ¬è¿½è¸ª
- [x] æ°´ä½çº¿æœºåˆ¶
- [x] è‡ªåŠ¨å¡«å……è§¦å‘å™¨
- [x] è¾…åŠ©å‡½æ•°ï¼ˆåˆ·æ–°/æ¸…ç†/ç»Ÿè®¡ï¼‰
- [ ] æŠ“å–å™¨æ”¹é€ ï¼ˆå¢é‡ upsertï¼‰
- [ ] åˆ†æå¼•æ“æ”¹é€ ï¼ˆçƒ­+å†·è¯»å–ï¼‰
- [ ] å®šæ—¶ä»»åŠ¡é…ç½®
- [ ] ç›‘æ§ä»ªè¡¨ç›˜

---

## ğŸ‰ æ€»ç»“

**å·²å®Œæˆï¼š**
- âœ… æ•°æ®åº“æ¶æ„æ”¹é€ 
- âœ… æ ¸å¿ƒåŠŸèƒ½å®ç°
- âœ… è¾…åŠ©å·¥å…·å‡½æ•°

**å¾…å®Œæˆï¼š**
- â³ æŠ“å–å™¨æ”¹é€ ï¼ˆæœ¬å‘¨ï¼‰
- â³ åˆ†æå¼•æ“æ”¹é€ ï¼ˆæœ¬å‘¨ï¼‰
- â³ å®šæ—¶ä»»åŠ¡é…ç½®ï¼ˆä¸‹å‘¨ï¼‰
- â³ ç›‘æ§ä»ªè¡¨ç›˜ï¼ˆä¸‹å‘¨ï¼‰

**é¢„æœŸæ”¶ç›Šï¼š**
- ğŸ“ˆ æ•°æ®é‡ï¼š8K â†’ 100K+ï¼ˆ12xï¼‰
- ğŸ“Š è¶‹åŠ¿åˆ†æï¼šæ”¯æŒ 7/14/30 å¤©çª—å£
- ğŸ” å»é‡å‡†ç¡®ï¼šé˜²æ­¢è½¬è´´/æ”¹å†™
- ğŸ¯ ç®—æ³•ä¼˜åŒ–ï¼šæœ‰å†å²æ ·æœ¬å¯å›æµ‹
- ğŸ’¾ å­˜å‚¨å¯æ§ï¼š~1.6 GB/90å¤©

---

**ğŸš€ å†·çƒ­åˆ†å±‚æ¶æ„å·²å°±ç»ªï¼ä¸‹ä¸€æ­¥ï¼šæ”¹é€ æŠ“å–å™¨å’Œåˆ†æå¼•æ“ã€‚**

