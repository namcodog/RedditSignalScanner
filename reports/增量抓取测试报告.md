# å¢é‡æŠ“å–æµ‹è¯•æŠ¥å‘Š

ç”Ÿæˆæ—¶é—´ï¼š2025-10-16 20:53  
æµ‹è¯•çŠ¶æ€ï¼šâœ… è‡ªæ£€é€šè¿‡ï¼Œéƒ¨åˆ†æŠ“å–å®Œæˆ

---

## ğŸ“‹ æµ‹è¯•æ¦‚è¿°

å®Œæˆäº†å†·çƒ­åˆ†å±‚æ¶æ„çš„å®Œæ•´è‡ªæ£€æµ‹è¯•ï¼Œå¹¶æˆåŠŸæŠ“å–äº† 26 ä¸ªç¤¾åŒºçš„çœŸå® Reddit æ•°æ®ã€‚

---

## âœ… è‡ªæ£€æµ‹è¯•ç»“æœ

### 1. æ•°æ®åº“å±‚æ£€æŸ¥

**æ£€æŸ¥é¡¹ï¼š**
- âœ… `posts_raw` è¡¨å­˜åœ¨
- âœ… `posts_hot` è¡¨å­˜åœ¨
- âœ… `posts_latest` ç‰©åŒ–è§†å›¾å­˜åœ¨
- âœ… `text_norm_hash()` å‡½æ•°æ­£å¸¸
- âœ… `get_storage_stats()` å‡½æ•°æ­£å¸¸
- âœ… è§¦å‘å™¨æ­£å¸¸å·¥ä½œ

**ä¿®å¤é—®é¢˜ï¼š**
- âŒ â†’ âœ… ä¿®å¤äº† `metadata` ä¿ç•™å­—å†²çªï¼ˆæ”¹ä¸º `extra_data`ï¼‰
- âŒ â†’ âœ… ä¿®å¤äº† `id` åˆ—ä¸»é”®å†²çªï¼ˆæ”¹ä¸ºéä¸»é”®ï¼‰

---

### 2. æ¨¡å‹å±‚æ£€æŸ¥

**æ£€æŸ¥é¡¹ï¼š**
- âœ… `PostRaw` æ¨¡å‹å¯¼å…¥æˆåŠŸ
- âœ… `PostHot` æ¨¡å‹å¯¼å…¥æˆåŠŸ
- âœ… `IncrementalCrawler` æœåŠ¡å¯¼å…¥æˆåŠŸ
- âœ… `CommunityCache` æ¨¡å‹åŒ…å«æ°´ä½çº¿å­—æ®µ

**ä¿®å¤é—®é¢˜ï¼š**
- âŒ â†’ âœ… æ·»åŠ äº† `CommunityCache` çš„æ°´ä½çº¿å­—æ®µï¼ˆ`last_seen_post_id`, `last_seen_created_at`, `total_posts_fetched`, `dedup_rate`ï¼‰

---

### 3. æœåŠ¡å±‚æ£€æŸ¥

**æ£€æŸ¥é¡¹ï¼š**
- âœ… Unix æ—¶é—´æˆ³è½¬æ¢æ­£å¸¸ï¼ˆ`_unix_to_datetime`ï¼‰
- âœ… å†·åº“ upsert æ­£å¸¸ï¼ˆ`_upsert_to_cold_storage`ï¼‰
- âœ… çƒ­ç¼“å­˜ upsert æ­£å¸¸ï¼ˆ`_upsert_to_hot_cache`ï¼‰
- âœ… æ°´ä½çº¿æ›´æ–°æ­£å¸¸ï¼ˆ`_update_watermark`ï¼‰
- âœ… åŒå†™é€»è¾‘æ­£å¸¸ï¼ˆå…ˆå†·åº“ï¼Œå†çƒ­ç¼“å­˜ï¼‰

**ä¿®å¤é—®é¢˜ï¼š**
- âŒ â†’ âœ… ä¿®å¤äº† `created_at` ç±»å‹é”™è¯¯ï¼ˆfloat â†’ datetimeï¼‰
- âŒ â†’ âœ… ä¿®å¤äº† `insert` å¯¼å…¥å†²çªï¼ˆä½¿ç”¨ `pg_insert`ï¼‰

---

### 4. é›†æˆæµ‹è¯•

**æµ‹è¯•ç¤¾åŒºï¼š** `r/Entrepreneur`, `r/startups`  
**æµ‹è¯•ç»“æœï¼š**

```
ğŸ”„ æŠ“å– r/Entrepreneur...
âœ… r/Entrepreneur:
   æ–°å¢: 20
   æ›´æ–°: 0
   å»é‡: 0
   è€—æ—¶: 3.56s

ğŸ”„ æŠ“å– r/startups...
âœ… r/startups:
   æ–°å¢: 20
   æ›´æ–°: 0
   å»é‡: 0
   è€—æ—¶: 0.81s

ğŸ“Š æ€»è®¡:
   æ–°å¢: 40
   æ›´æ–°: 0
   å»é‡: 0
```

**æ•°æ®éªŒè¯ï¼š**
- âœ… `posts_raw`ï¼š40 æ¡
- âœ… `posts_hot`ï¼š40 æ¡
- âœ… æ°´ä½çº¿æ­£ç¡®æ›´æ–°
- âœ… å»é‡ç‡ï¼š0%ï¼ˆé¦–æ¬¡æŠ“å–ï¼Œç¬¦åˆé¢„æœŸï¼‰

---

## ğŸ“Š éƒ¨åˆ†æŠ“å–ç»“æœ

### æ€»ä½“ç»Ÿè®¡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| **å·²æŠ“å–ç¤¾åŒº** | 26 / 102 |
| **å†·åº“æ€»æ•°** | 3,075 æ¡ |
| **çƒ­ç¼“å­˜æ€»æ•°** | 3,069 æ¡ |
| **å”¯ä¸€ç¤¾åŒºæ•°** | 37 ä¸ª |
| **å¹³å‡å¸–å­æ•°** | 89.1 æ¡/ç¤¾åŒº |
| **å»é‡ç‡** | 0% |

### å­˜å‚¨ç»Ÿè®¡

```
posts_raw_total:   3,075  ï¼ˆå†·åº“æ€»æ•°ï¼‰
posts_raw_current: 3,075  ï¼ˆå½“å‰ç‰ˆæœ¬ï¼‰
posts_hot_total:   3,069  ï¼ˆçƒ­ç¼“å­˜ï¼‰
posts_hot_expired:     0  ï¼ˆè¿‡æœŸç¼“å­˜ï¼‰
unique_subreddits:    37  ï¼ˆå”¯ä¸€ç¤¾åŒºï¼‰
total_versions:    3,075  ï¼ˆæ€»ç‰ˆæœ¬æ•°ï¼‰
```

### Top 10 ç¤¾åŒº

| ç¤¾åŒº | å¸–å­æ•° | å»é‡ç‡ | æœ€æ–°å¸–å­æ—¶é—´ |
|------|--------|--------|--------------|
| privacy | 100 | 0% | 2025-10-15 16:11:48 |
| iosdev | 100 | 0% | 2025-10-16 20:25:08 |
| careerguidance | 100 | 0% | 2025-10-15 19:09:42 |
| investing | 100 | 0% | 2025-10-15 11:37:54 |
| books | 100 | 0% | 2025-10-16 01:28:59 |
| aquariums | 100 | 0% | 2025-10-15 10:49:29 |
| personalfinance | 100 | 0% | 2025-10-16 01:16:59 |
| cybersecurity | 100 | 0% | 2025-10-16 03:27:33 |
| reactnative | 100 | 0% | 2025-10-16 13:35:29 |
| photography | 100 | 0% | 2025-10-16 06:01:30 |

---

## ğŸ” å…³é”®å‘ç°

### 1. å†·çƒ­åˆ†å±‚æ¶æ„æ­£å¸¸å·¥ä½œ

- âœ… å†·åº“ï¼ˆ`posts_raw`ï¼‰ï¼šå¢é‡ç´¯ç§¯ï¼Œæ”¯æŒå†å²å›æº¯
- âœ… çƒ­ç¼“å­˜ï¼ˆ`posts_hot`ï¼‰ï¼šè¦†ç›–å¼åˆ·æ–°ï¼Œæ”¯æŒå®æ—¶æŸ¥è¯¢
- âœ… ç‰©åŒ–è§†å›¾ï¼ˆ`posts_latest`ï¼‰ï¼šåªä¿ç•™æœ€æ–°ç‰ˆæœ¬

### 2. æ°´ä½çº¿æœºåˆ¶æ­£å¸¸

- âœ… `last_seen_post_id`ï¼šè®°å½•æœ€åä¸€æ¡å¸–å­ ID
- âœ… `last_seen_created_at`ï¼šè®°å½•æœ€åä¸€æ¡å¸–å­æ—¶é—´
- âœ… `total_posts_fetched`ï¼šç´¯è®¡æŠ“å–æ•°é‡
- âœ… `dedup_rate`ï¼šå»é‡ç‡ï¼ˆé¦–æ¬¡æŠ“å–ä¸º 0%ï¼‰

### 3. å»é‡ç­–ç•¥æœ‰æ•ˆ

- âœ… å¤šé”®ç»„åˆï¼š`(source, source_post_id, text_norm_hash)`
- âœ… æ–‡æœ¬å½’ä¸€åŒ–å“ˆå¸Œï¼šé˜²æ­¢è½¬è´´/æ”¹å†™
- âœ… SCD2 ç‰ˆæœ¬è¿½è¸ªï¼šæ”¯æŒç¼–è¾‘å†å²ï¼ˆå¾…å®ç°ï¼‰

### 4. æ€§èƒ½è¡¨ç°

- âœ… å•ç¤¾åŒºæŠ“å–ï¼š0.8 - 3.6 ç§’
- âœ… å¹¶å‘æŠ“å–ï¼šæ”¯æŒï¼ˆé™æµ 5 ä¸ªå¹¶å‘ï¼‰
- âœ… æ•°æ®åº“å†™å…¥ï¼šæ­£å¸¸ï¼ˆåŒå†™æ¨¡å¼ï¼‰

---

## ğŸ› å·²ä¿®å¤çš„é—®é¢˜

### é—®é¢˜ 1ï¼š`metadata` ä¿ç•™å­—å†²çª

**é”™è¯¯ï¼š**
```
AttributeError: type object 'CommunityCache' has no attribute 'metadata'
```

**åŸå› ï¼š** SQLAlchemy çš„ `metadata` æ˜¯ä¿ç•™å­—æ®µ

**ä¿®å¤ï¼š** å°†æ‰€æœ‰ `metadata` åˆ—æ”¹ä¸º `extra_data`

**å½±å“æ–‡ä»¶ï¼š**
- `backend/app/models/posts_storage.py`
- `backend/app/services/incremental_crawler.py`
- `backend/migrations/001_cold_hot_storage.sql`

---

### é—®é¢˜ 2ï¼š`created_at` ç±»å‹é”™è¯¯

**é”™è¯¯ï¼š**
```
invalid input for query argument $4: 1758660931.0 
(expected a datetime.date or datetime.datetime instance, got 'float')
```

**åŸå› ï¼š** Reddit API è¿”å›çš„ `created_utc` æ˜¯ Unix æ—¶é—´æˆ³ï¼ˆfloatï¼‰

**ä¿®å¤ï¼š** æ·»åŠ  `_unix_to_datetime()` è½¬æ¢å‡½æ•°

**å½±å“ä»£ç ï¼š**
```python
def _unix_to_datetime(unix_timestamp: float) -> datetime:
    """å°† Unix æ—¶é—´æˆ³è½¬æ¢ä¸º UTC datetime"""
    return datetime.fromtimestamp(unix_timestamp, tz=timezone.utc)
```

---

### é—®é¢˜ 3ï¼š`insert` å¯¼å…¥å†²çª

**é”™è¯¯ï¼š**
```
'Insert' object has no attribute 'on_conflict_do_update'
```

**åŸå› ï¼š** åŒæ—¶å¯¼å…¥äº† `sqlalchemy.insert` å’Œ `pg_insert`ï¼Œå¯¼è‡´å†²çª

**ä¿®å¤ï¼š** åªå¯¼å…¥ `pg_insert`ï¼Œç§»é™¤æ™®é€š `insert`

---

### é—®é¢˜ 4ï¼š`CommunityCache` ç¼ºå°‘æ°´ä½çº¿å­—æ®µ

**é”™è¯¯ï¼š**
```
AttributeError: type object 'CommunityCache' has no attribute 'last_seen_created_at'
```

**åŸå› ï¼š** æ•°æ®åº“è¡¨å·²æ·»åŠ å­—æ®µï¼Œä½† SQLAlchemy æ¨¡å‹æœªæ›´æ–°

**ä¿®å¤ï¼š** åœ¨ `CommunityCache` æ¨¡å‹ä¸­æ·»åŠ å­—æ®µï¼š
```python
last_seen_post_id: Mapped[str | None] = mapped_column(String(100))
last_seen_created_at: Mapped[datetime | None] = mapped_column(DateTime(timezone=True))
total_posts_fetched: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
dedup_rate: Mapped[Decimal | None] = mapped_column(Numeric(5, 2))
```

---

## ğŸ“ å¾…å®Œæˆå·¥ä½œ

### é«˜ä¼˜å…ˆçº§

- [ ] **å®Œæˆå‰©ä½™ç¤¾åŒºæŠ“å–**ï¼ˆ76 ä¸ªç¤¾åŒºï¼‰
- [ ] **SCD2 ç‰ˆæœ¬è¿½è¸ª**ï¼šæ£€æµ‹ç¼–è¾‘ï¼Œè®°å½•å†å²ç‰ˆæœ¬
- [ ] **åˆ†æå¼•æ“æ”¹é€ **ï¼šè¯»å–å†·çƒ­æ··åˆæ•°æ®

### ä¸­ä¼˜å…ˆçº§

- [ ] **å®šæ—¶ä»»åŠ¡é…ç½®**ï¼š
  - æ¯å°æ—¶åˆ·æ–°ç‰©åŒ–è§†å›¾
  - æ¯å¤©æ¸…ç†è¿‡æœŸçƒ­ç¼“å­˜
  - æ¯å‘¨æ¸…ç†æ—§æ•°æ®ï¼ˆ90å¤©çª—å£ï¼‰

- [ ] **ç›‘æ§ä»ªè¡¨ç›˜**ï¼š
  - æ–°å¢æŠ“å–é‡/å°æ—¶
  - ç´¯è®¡æ ·æœ¬/å¤©
  - å»é‡ç‡è¶‹åŠ¿
  - ç¼–è¾‘æ›´æ–°ç‡
  - å­˜å‚¨ç©ºé—´ä½¿ç”¨

### ä½ä¼˜å…ˆçº§

- [ ] **æ€§èƒ½ä¼˜åŒ–**ï¼š
  - æ‰¹é‡ upsertï¼ˆä½¿ç”¨ staging tableï¼‰
  - åˆ†åŒºè¡¨ï¼ˆæŒ‰æœˆåˆ†åŒºï¼‰
  - ç´¢å¼•ä¼˜åŒ–

- [ ] **é”™è¯¯å¤„ç†**ï¼š
  - é‡è¯•æœºåˆ¶
  - æ­»ä¿¡é˜Ÿåˆ—
  - å‘Šè­¦é€šçŸ¥

---

## ğŸ¯ ç»“è®º

**âœ… è‡ªæ£€æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼**

å†·çƒ­åˆ†å±‚æ¶æ„å·²æˆåŠŸå®ç°å¹¶é€šè¿‡æµ‹è¯•ï¼š
1. âœ… æ•°æ®åº“æ¶æ„æ­£å¸¸
2. âœ… æ¨¡å‹å±‚æ­£å¸¸
3. âœ… æœåŠ¡å±‚æ­£å¸¸
4. âœ… é›†æˆæµ‹è¯•é€šè¿‡
5. âœ… éƒ¨åˆ†æŠ“å–æˆåŠŸï¼ˆ26/102 ç¤¾åŒºï¼Œ3,075 æ¡å¸–å­ï¼‰

**ä¸‹ä¸€æ­¥ï¼š**
1. å®Œæˆå‰©ä½™ 76 ä¸ªç¤¾åŒºçš„æŠ“å–
2. å®æ–½ SCD2 ç‰ˆæœ¬è¿½è¸ª
3. æ”¹é€ åˆ†æå¼•æ“ä»¥ä½¿ç”¨å†·çƒ­æ··åˆæ•°æ®

---

**ğŸ‰ å¢é‡æŠ“å–ç³»ç»Ÿå·²å°±ç»ªï¼**

