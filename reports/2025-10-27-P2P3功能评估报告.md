# P2/P3 功能评估报告

**日期**: 2025-10-27  
**评估人**: AI Agent  
**目的**: 评估导出历史、分享功能、多语言支持等 P2/P3 级别功能的实现需求

---

## 1. 导出历史服务端化评估

### 1.1 当前实现

**存储方式**: `localStorage`  
**位置**: `frontend/src/utils/exportHistory.ts`

**数据结构**:
```typescript
interface ExportHistoryEntry {
  taskId: string;
  format: 'json' | 'csv' | 'text' | 'pdf';
  timestamp: string;  // ISO 8601
}
```

**功能**:
- ✅ 记录导出历史
- ✅ 查询导出历史
- ✅ 按时间排序
- ❌ 跨设备同步
- ❌ 持久化存储
- ❌ 导出统计分析

---

### 1.2 服务端化需求分析

#### **优点** ✅

1. **跨设备同步**
   - 用户在不同设备上可以看到完整的导出历史
   - 提升用户体验

2. **数据持久化**
   - 不受浏览器清理影响
   - 更可靠的数据存储

3. **统计分析**
   - 可以分析用户导出偏好
   - 优化导出功能

4. **审计追踪**
   - 记录用户行为
   - 满足合规要求

#### **缺点** ❌

1. **增加服务器负载**
   - 每次导出都需要写入数据库
   - 增加 API 调用

2. **开发成本**
   - 需要新增 API 接口
   - 需要数据库表设计
   - 需要前端适配

3. **隐私问题**
   - 服务端记录用户行为
   - 需要明确隐私政策

---

### 1.3 建议

**短期（当前阶段）**: ❌ **不建议服务端化**

**理由**:
- 当前用户量较小，跨设备需求不强
- localStorage 足够满足基本需求
- 开发成本高，优先级低

**长期（产品成熟后）**: ✅ **建议服务端化**

**触发条件**:
- 用户反馈需要跨设备同步
- 需要导出统计分析
- 用户量达到一定规模（如 1000+ 活跃用户）

**实现方案**:
```sql
-- 数据库表设计
CREATE TABLE export_history (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id),
    task_id UUID NOT NULL REFERENCES tasks(id),
    format VARCHAR(10) NOT NULL,  -- json, csv, text, pdf
    exported_at TIMESTAMP NOT NULL DEFAULT NOW(),
    file_size_bytes INTEGER,
    INDEX idx_user_exported (user_id, exported_at DESC)
);
```

```python
# 后端 API
@router.post("/api/export-history")
async def record_export(
    task_id: UUID,
    format: str,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_session),
):
    # 记录导出历史
    pass

@router.get("/api/export-history")
async def get_export_history(
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_session),
):
    # 查询导出历史
    pass
```

---

## 2. 分享功能优化评估

### 2.1 当前实现

**功能**:
- ✅ 复制分享链接
- ✅ 原生分享 API（移动端）
- ✅ 降级方案（execCommand）
- ✅ Toast 提示

**安全性**:
- ⚠️ 分享链接永久有效
- ⚠️ 无权限控制
- ⚠️ 任何人都可以访问

---

### 2.2 安全性改进建议

#### **建议 1: 分享链接过期机制** (P3)

**当前**: 永久有效  
**建议**: 7 天过期

**实现方案**:
```python
# 后端生成带过期时间的分享 token
@router.post("/api/report/{task_id}/share")
async def create_share_link(
    task_id: UUID,
    expires_in_days: int = 7,
    current_user: User = Depends(get_current_user),
):
    token = generate_share_token(task_id, expires_in_days)
    return {"share_url": f"/report/shared/{token}"}

# 前端访问分享链接
@router.get("/report/shared/{token}")
async def view_shared_report(token: str):
    task_id = verify_share_token(token)  # 验证过期时间
    if not task_id:
        raise HTTPException(404, "分享链接已过期")
    return get_report(task_id)
```

**优先级**: **P3**（按需实现）

---

#### **建议 2: 分享权限控制** (P3)

**场景**:
- 公开分享：任何人可访问
- 团队分享：仅团队成员可访问
- 密码保护：需要密码才能访问

**实现方案**:
```python
class SharePermission(str, Enum):
    PUBLIC = "public"
    TEAM = "team"
    PASSWORD = "password"

@router.post("/api/report/{task_id}/share")
async def create_share_link(
    task_id: UUID,
    permission: SharePermission = SharePermission.PUBLIC,
    password: str | None = None,
):
    # 生成带权限的分享链接
    pass
```

**优先级**: **P3**（按需实现）

---

## 3. 多语言支持评估

### 3.1 当前实现

**已支持**:
- ✅ 中文（zh）
- ✅ 英文（en）
- ✅ 前端 UI 翻译
- ✅ 语言切换功能

**位置**: `frontend/src/i18n/TranslationProvider.tsx`

---

### 3.2 改进建议

#### **建议 1: 使用 i18next** (P3)

**当前**: 自定义翻译系统  
**建议**: 迁移到 `i18next`

**优点**:
- 更强大的功能（插值、复数、命名空间）
- 社区支持
- 更好的类型安全

**实现方案**:
```bash
npm install i18next react-i18next
```

```typescript
// i18n.ts
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';

i18n
  .use(initReactI18next)
  .init({
    resources: {
      zh: { translation: zhTranslations },
      en: { translation: enTranslations },
    },
    lng: 'zh',
    fallbackLng: 'en',
    interpolation: { escapeValue: false },
  });

export default i18n;
```

**优先级**: **P3**（按需实现）

---

#### **建议 2: 后端内容翻译** (P3)

**当前**: 仅前端 UI 翻译  
**问题**: 报告内容（痛点、机会等）仍是中文

**建议**: 使用翻译 API（如 DeepL、Google Translate）

**实现方案**:
```python
@router.get("/api/report/{task_id}")
async def get_report(
    task_id: UUID,
    lang: str = Query("zh", regex="^(zh|en)$"),
):
    report = await service.get_report(task_id)
    
    if lang == "en":
        # 翻译报告内容
        report = await translate_report(report, target_lang="en")
    
    return report
```

**优先级**: **P3**（按需实现，成本较高）

---

## 4. 其他 P3 功能评估

### 4.1 报告版本控制

**需求**: 用户可以查看报告的历史版本

**实现方案**:
- 在数据库中保留 `Analysis` 的历史记录
- 添加 `version` 字段
- 提供版本对比功能

**优先级**: **P3**

---

### 4.2 报告协作功能

**需求**: 多人可以对同一份报告添加批注、标记

**实现方案**:
- 添加 `ReportComment` 表
- 实时协作（WebSocket）
- 权限控制

**优先级**: **P3**

---

### 4.3 报告模板定制

**需求**: 用户可以自定义报告样式和内容

**实现方案**:
- 提供模板编辑器
- 支持 Markdown/HTML 模板
- 变量替换

**优先级**: **P3**

---

## 5. 总结与建议

### 5.1 优先级排序

| 功能 | 优先级 | 建议时间 | 理由 |
|------|--------|----------|------|
| 导出历史服务端化 | P3 | 产品成熟后 | 当前 localStorage 够用 |
| 分享链接过期 | P3 | 按需 | 安全性提升，但非紧急 |
| 分享权限控制 | P3 | 按需 | 企业用户可能需要 |
| i18next 迁移 | P3 | 按需 | 当前翻译系统够用 |
| 后端内容翻译 | P3 | 按需 | 成本高，需求不明确 |
| 报告版本控制 | P3 | 长期 | 高级功能 |
| 报告协作 | P3 | 长期 | 高级功能 |
| 报告模板定制 | P3 | 长期 | 高级功能 |

---

### 5.2 当前阶段建议

**立即执行**: ✅ **无**  
所有 P3 功能都可以延后实现

**短期观察**:
- 收集用户反馈
- 分析使用数据
- 评估真实需求

**长期规划**:
- 根据用户反馈优先实现高需求功能
- 考虑商业化需求（如企业版功能）

---

## 6. 附录

### 6.1 相关文件

- `frontend/src/utils/exportHistory.ts` - 导出历史
- `frontend/src/pages/ReportPage.tsx` - 分享功能
- `frontend/src/i18n/TranslationProvider.tsx` - 多语言

### 6.2 参考资料

- i18next 文档: https://www.i18next.com/
- DeepL API: https://www.deepl.com/pro-api
- Web Share API: https://developer.mozilla.org/en-US/docs/Web/API/Navigator/share

