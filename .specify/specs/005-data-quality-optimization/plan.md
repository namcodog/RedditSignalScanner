# Implementation Plan: 数据与算法双轨优化

## Summary
围绕“样本先扩量、规则再磨锋利、评测必须在线”的思路，落地 Reddit 信号扫描器的数据抓取、社区治理、规则打分和度量看板改造，目标是在 1 个月内把可分析帖子量提升 2–5 倍，同时把机会识别精度和报告行动力稳定到可复用的流水线。

## Technical Context
- 后端：FastAPI + Celery；Redis 作为缓存；PostgreSQL 管理 `community_pool`、`community_cache`、任务与打分结果。
- 爬虫队列：Celery Beat 定时任务，现有刷新节奏为统一周期；失败重试策略走默认指数退避。
- 分析引擎：基于规则的机会打分器（关键词权重 + 频次 + 紧迫度等），任务队列写入 `analysis_results`。
- 监控：现阶段缺乏“缓存命中率、空命中率、有效帖子”等可视化指标；报告模版未纳入行动位。
- MCP 工具：Spec Kit 计划文档作为执行蓝本；后续任务将同步到 reports/phase-log。

## Step-by-Step Plan
1) **基线监测与数据标签 (T+0~0.5 天)**
   - 补齐 Redis/PG 的缓存命中率、有效帖子数（24h/72h）、空结果统计；`community_cache` 记录 `empty_hit`、`last_crawled_at`。
   - 在 Celery 任务内埋点：抓取命中成功/为空/失败次数，统一写入监控表或 Prometheus exporter。
2) **刷新调度改造 (T+0.5~1.5 天)**
   - 基于历史表现维护社区价值分；调整 Celery Beat：Top20 → 2h、次优40 → 6h、长尾 → 24h。
   - 增加 `last_crawled_at > 8h 且有效贴 < 阈值` 的精准 API 补抓任务；失败回写 `empty_hit`。
3) **样本下限与补抓兜底 (T+1.5~2 天)**
   - 在分析前置检查缓存样本量（目标≥1500），不足则触发“关键词+时间窗”抓取任务。
   - 抓取任务支持按关键词、时间窗调用 Reddit API，并标记来源类型（cache/search）。
4) **社区池扩容 & 黑名单 (T+2~3 天)**
   - 扩充 `community_pool` 至 ≥300，按历史质量排序并加入类目标签；限制同类目 ≤5。
   - 建立黑名单/降权配置文件（广告泛滥、外链农场等），加载到抓取与分析阶段。
5) **规则关键词与否定列表 (T+3~4 天)**
   - 新增正例关键词（need、urgent 等）与负例关键词（giveaway、for fun 等）配置；集成语义否定检测（`not interested` 等）。
   - 在评分器中实现“正负样本对冲”逻辑，支持 YAML/JSON 配置热更新。
6) **上下文窗口与噪声剔除 (T+4~5 天)**
   - 解析帖子正文，去除 URL、代码块、引用块，再进行句级评分。
   - 评分时取当前句 + 前后各 1 句窗口，避免否定句误判。
7) **模板加成与反模板 (T+5~6 天)**
   - 添加金额/时间/数量等正向模板正则（例如 `$[0-9]+`、`in \\d+ weeks`），命中后加权 +0.3。
   - 引入招聘转发、抽奖、纯宣发反模板，命中直接降权或置零。
8) **抽样标注与阈值校准 (T+6~7 天)**
   - 抽样 200–500 条帖子，人工标注“机会/非机会、强/中/弱”；
   - 使用该金标集网格搜索阈值，优化 Precision@K/F1；把阈值存入配置并记录 reports/phase-log。
9) **去重与主题聚合 (T+7~9 天)**
   - 引入 MinHash/Jaccard 去重，标题去停用词后聚合相似度 >0.85 的帖子。
   - 主贴保留，重复项计为“证据计数”，写入分析结果供报告使用。
10) **实体词典与匹配槽位 (T+9~12 天)**
    - 建立行业实体词典（产品/功能/受众/行业四槽位）与竞品域词库。
    - 评分器中按槽位统计命中度，竞品共现给予 0.2–0.4 加成。
11) **态度极性过滤 (T+12~13 天)**
    - 定义强负面词库（doesn’t work、hate 等），命中即降权或过滤，避免把抱怨当机会。
12) **仪表盘与红线策略 (T+13~15 天)**
    - 生成每日跑分表（CSV/Looker Studio 等），记录缓存命中、有效帖子、重复率、空结果、Precision@K。
    - 定义红线触发逻辑：有效帖子<1500 或命中<60% → 使用保守模式（10 社区+补抓）；重复率>20% → 提升去重；Precision@50<0.6 → 提高阈值。
13) **报告行动位强化 (T+15~18 天)**
    - 报告模版新增行动位：问题定义、证据链 2 条、建议动作、置信度、优先级计算（置信度 × 紧迫性 × 产品适配度）。
    - 在 API/前端渲染中展示可点击链接与建议话术草稿。
14) **两周迭代总结 (T+18~21 天)**
    - 复盘社区扩容、规则改造、阈值调整效果；在 reports/phase-log 写入阶段总结。
    - 规划后一月工作：轻量 NER、趋势分析、证据图谱。
15) **一月内延伸 (T+21~30 天)**
    - 引入轻量 NER（词典+正则或 spaCy 管线）替代纯关键词；输出主题趋势曲线（7/14/30 天）。
    - 构建“证据图谱”数据结构，为每条建议附上 2–3 条证据引用。

## Success Criteria
- 可用帖子样本量较现状提升 2–5 倍；低于 1500 条时自动触发补抓。
- 缓存命中率 ≥60%，分析引擎 5 分钟内完成；出现红线时能够自动降级。
- Precision@50 ≥0.6，且每周阈值校准流程固化在配置中。
- 报告行动位具备问题定义、证据链、建议动作、置信度/优先级，便于销售/产品直接执行。

## Notes
- 所有配置（关键词、模板、社区黑名单、阈值）应集中存放并纳入版本控制。
- 关键指标写入仪表盘前，先在 `reports/phase-log/phaseN.md` 记录改动与数据差异。
- MCP 工具操作、超 12 秒的排障需同步记录到 `reports/`，保持 SDD 流程闭环。
